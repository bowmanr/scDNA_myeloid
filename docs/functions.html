<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6.2 Functions | Single cell mutational profiling delineates clonal trajectories in myeloid malignancies</title>
  <meta name="description" content="This is a code base for all of the analyses performed in Miles, Bowman et al. " />
  <meta name="generator" content="bookdown 0.22.2 and GitBook 2.6.7" />

  <meta property="og:title" content="6.2 Functions | Single cell mutational profiling delineates clonal trajectories in myeloid malignancies" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a code base for all of the analyses performed in Miles, Bowman et al. " />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6.2 Functions | Single cell mutational profiling delineates clonal trajectories in myeloid malignancies" />
  
  <meta name="twitter:description" content="This is a code base for all of the analyses performed in Miles, Bowman et al. " />
  

<meta name="author" content="Robert Bowman" />


<meta name="date" content="2021-05-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="AppendixA.html"/>
<link rel="next" href="references.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Foreward</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-extraction-and-setup.html"><a href="data-extraction-and-setup.html"><i class="fa fa-check"></i><b>2.1</b> Data Extraction and Setup</a></li>
<li class="chapter" data-level="2.2" data-path="hdf5-and-loom-input.html"><a href="hdf5-and-loom-input.html"><i class="fa fa-check"></i><b>2.2</b> HDF5 and Loom input</a></li>
<li class="chapter" data-level="2.3" data-path="tapestri-package.html"><a href="tapestri-package.html"><i class="fa fa-check"></i><b>2.3</b> Tapestri Package</a></li>
<li class="chapter" data-level="2.4" data-path="post-processing.html"><a href="post-processing.html"><i class="fa fa-check"></i><b>2.4</b> Post processing</a></li>
<li class="chapter" data-level="2.5" data-path="assessing-clonal-abundance.html"><a href="assessing-clonal-abundance.html"><i class="fa fa-check"></i><b>2.5</b> Assessing clonal abundance</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="manuscript-analysis.html"><a href="manuscript-analysis.html"><i class="fa fa-check"></i><b>3</b> Manuscript analysis</a>
<ul>
<li class="chapter" data-level="3.1" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html"><i class="fa fa-check"></i><b>3.1</b> Figure 1: Cohort characterization</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#cohort-characteristics-ef1a-d"><i class="fa fa-check"></i><b>3.1.1</b> Cohort characteristics (EF1A-D)</a></li>
<li class="chapter" data-level="3.1.2" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#mutation-co-occurence"><i class="fa fa-check"></i><b>3.1.2</b> Mutation Co-occurence</a></li>
<li class="chapter" data-level="3.1.3" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#oncoprint-figure-1a"><i class="fa fa-check"></i><b>3.1.3</b> Oncoprint: Figure 1A</a></li>
<li class="chapter" data-level="3.1.4" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#sample-clonality-figure-1ce-figure-2ab"><i class="fa fa-check"></i><b>3.1.4</b> Sample clonality: Figure 1C,E Figure 2A,B</a></li>
<li class="chapter" data-level="3.1.5" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#clonograph-figure-1d"><i class="fa fa-check"></i><b>3.1.5</b> Clonograph: Figure 1D</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html"><i class="fa fa-check"></i><b>3.2</b> Figure 2: Clonality</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html#clonality-in-disease-states"><i class="fa fa-check"></i><b>3.2.1</b> Clonality in disease states</a></li>
<li class="chapter" data-level="3.2.2" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html#clonality-in-co-mutational-groups"><i class="fa fa-check"></i><b>3.2.2</b> Clonality in co-mutational groups</a></li>
<li class="chapter" data-level="3.2.3" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html#clonality-assocation-with-vaf"><i class="fa fa-check"></i><b>3.2.3</b> Clonality assocation with VAF</a></li>
<li class="chapter" data-level="3.2.4" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html#co-mutation-and-clonality"><i class="fa fa-check"></i><b>3.2.4</b> Co-mutation and clonality</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="figure-3-genetic-trajectory-analysis.html"><a href="figure-3-genetic-trajectory-analysis.html"><i class="fa fa-check"></i><b>4</b> Figure 3: Genetic Trajectory analysis</a>
<ul>
<li class="chapter" data-level="4.1" data-path="introductory-text-and-philisophy-of-approach.html"><a href="introductory-text-and-philisophy-of-approach.html"><i class="fa fa-check"></i><b>4.1</b> Introductory text and philisophy of approach:</a></li>
<li class="chapter" data-level="4.2" data-path="functions-for-reward-matrix-and-querying-initating-mutations.html"><a href="functions-for-reward-matrix-and-querying-initating-mutations.html"><i class="fa fa-check"></i><b>4.2</b> Functions for reward matrix and querying initating mutations</a></li>
<li class="chapter" data-level="4.3" data-path="executing-the-analysis.html"><a href="executing-the-analysis.html"><i class="fa fa-check"></i><b>4.3</b> Executing the Analysis</a></li>
<li class="chapter" data-level="4.4" data-path="plotting-the-data.html"><a href="plotting-the-data.html"><i class="fa fa-check"></i><b>4.4</b> Plotting the data</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>5</b> Final Words</a></li>
<li class="chapter" data-level="6" data-path="Appendix.html"><a href="Appendix.html"><i class="fa fa-check"></i><b>6</b> Appendix</a>
<ul>
<li class="chapter" data-level="6.1" data-path="AppendixA.html"><a href="AppendixA.html"><i class="fa fa-check"></i><b>6.1</b> Import from Tapestri Insights</a></li>
<li class="chapter" data-level="6.2" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>6.2</b> Functions</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Single cell mutational profiling delineates clonal trajectories in myeloid malignancies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="functions" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Functions</h2>
<p>I’m likely going to wrap all of this into a package soon, but here we will start with a set of packages and functions used throughout the study. I need to go through and annotate with package was used with with function, and that will take a little time. So for the sake of making the code available as soon as possible, I’ll present the intermediate product here.</p>
<p>Packages
The following are a list of packages that are used during the study. I will update this list with the minial set and begin to put together a package soon.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="functions.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ape)</span>
<span id="cb93-2"><a href="functions.html#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(circlize)</span>
<span id="cb93-3"><a href="functions.html#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cooccur)</span>
<span id="cb93-4"><a href="functions.html#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb93-5"><a href="functions.html#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb93-6"><a href="functions.html#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb93-7"><a href="functions.html#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb93-8"><a href="functions.html#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb93-9"><a href="functions.html#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gdata)</span>
<span id="cb93-10"><a href="functions.html#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggbeeswarm)</span>
<span id="cb93-11"><a href="functions.html#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggcorrplot)</span>
<span id="cb93-12"><a href="functions.html#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggnet)</span>
<span id="cb93-13"><a href="functions.html#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplotify)</span>
<span id="cb93-14"><a href="functions.html#cb93-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb93-15"><a href="functions.html#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb93-16"><a href="functions.html#cb93-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggridges)</span>
<span id="cb93-17"><a href="functions.html#cb93-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb93-18"><a href="functions.html#cb93-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb93-19"><a href="functions.html#cb93-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggthemes)</span>
<span id="cb93-20"><a href="functions.html#cb93-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggtree)</span>
<span id="cb93-21"><a href="functions.html#cb93-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb93-22"><a href="functions.html#cb93-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb93-23"><a href="functions.html#cb93-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(miscTools)</span>
<span id="cb93-24"><a href="functions.html#cb93-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(network)</span>
<span id="cb93-25"><a href="functions.html#cb93-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pals)</span>
<span id="cb93-26"><a href="functions.html#cb93-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb93-27"><a href="functions.html#cb93-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb93-28"><a href="functions.html#cb93-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(phylobase)</span>
<span id="cb93-29"><a href="functions.html#cb93-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb93-30"><a href="functions.html#cb93-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(qgraph)</span>
<span id="cb93-31"><a href="functions.html#cb93-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb93-32"><a href="functions.html#cb93-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rcompanion)</span>
<span id="cb93-33"><a href="functions.html#cb93-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ReinforcementLearning)</span>
<span id="cb93-34"><a href="functions.html#cb93-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb93-35"><a href="functions.html#cb93-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sna)</span>
<span id="cb93-36"><a href="functions.html#cb93-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidygraph)</span>
<span id="cb93-37"><a href="functions.html#cb93-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb93-38"><a href="functions.html#cb93-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb93-39"><a href="functions.html#cb93-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TRONCO)</span>
<span id="cb93-40"><a href="functions.html#cb93-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span>
<span id="cb93-41"><a href="functions.html#cb93-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(widyr)</span></code></pre></div>
<p>Custom functions</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="functions.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">stringsAsFactors=</span><span class="cn">FALSE</span>)</span>
<span id="cb94-2"><a href="functions.html#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="functions.html#cb94-3" aria-hidden="true" tabindex="-1"></a>random_distribution_NGT_CI <span class="ot">&lt;-</span> <span class="cf">function</span>(NGT_to_clone_list,clonal_abundance,sample_to_test,replicates,clone_cutoff){</span>
<span id="cb94-4"><a href="functions.html#cb94-4" aria-hidden="true" tabindex="-1"></a>                        mat_of_interest <span class="ot">&lt;-</span> NGT_to_clone[[sample_to_test]][,<span class="dv">1</span><span class="sc">:</span>(<span class="fu">ncol</span>(NGT_to_clone[[sample_to_test]])<span class="sc">-</span><span class="dv">1</span>)]</span>
<span id="cb94-5"><a href="functions.html#cb94-5" aria-hidden="true" tabindex="-1"></a>                        bulk_VAF_order <span class="ot">&lt;-</span><span class="fu">names</span>(<span class="fu">sort</span>(<span class="fu">colSums</span>(mat_of_interest),<span class="at">decreasing=</span><span class="cn">TRUE</span>))</span>
<span id="cb94-6"><a href="functions.html#cb94-6" aria-hidden="true" tabindex="-1"></a>                        test<span class="ot">&lt;-</span><span class="fu">replicate</span>(<span class="at">n=</span>replicates,<span class="fu">apply</span>(mat_of_interest,<span class="at">MARGIN=</span><span class="fu">c</span>(<span class="dv">2</span>),<span class="cf">function</span>(x){</span>
<span id="cb94-7"><a href="functions.html#cb94-7" aria-hidden="true" tabindex="-1"></a>                          z<span class="ot">&lt;-</span><span class="fu">sample</span>(x,<span class="at">size=</span><span class="fu">length</span>(x),<span class="at">replace=</span><span class="cn">FALSE</span>)</span>
<span id="cb94-8"><a href="functions.html#cb94-8" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">return</span>(<span class="fu">as.numeric</span>(z))}),<span class="at">simplify =</span> <span class="st">&quot;array&quot;</span>)</span>
<span id="cb94-9"><a href="functions.html#cb94-9" aria-hidden="true" tabindex="-1"></a>                        test2<span class="ot">&lt;-</span><span class="fu">apply</span>(test,<span class="dv">3</span>,<span class="cf">function</span>(q){</span>
<span id="cb94-10"><a href="functions.html#cb94-10" aria-hidden="true" tabindex="-1"></a>                          x<span class="ot">&lt;-</span><span class="fu">data.frame</span>(q[,bulk_VAF_order],</span>
<span id="cb94-11"><a href="functions.html#cb94-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">&quot;Clone&quot;</span><span class="ot">=</span><span class="fu">apply</span>(q[,bulk_VAF_order],<span class="dv">1</span>, <span class="cf">function</span>(p){<span class="fu">paste</span>(p,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)}))</span>
<span id="cb94-12"><a href="functions.html#cb94-12" aria-hidden="true" tabindex="-1"></a>                          y<span class="ot">&lt;-</span><span class="fu">data.table</span>(<span class="fu">data.frame</span>(<span class="st">&quot;Count&quot;</span><span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">table</span>(x[,<span class="st">&quot;Clone&quot;</span>])),</span>
<span id="cb94-13"><a href="functions.html#cb94-13" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">&quot;Clone&quot;</span><span class="ot">=</span><span class="fu">names</span>(<span class="fu">table</span>(x[,<span class="st">&quot;Clone&quot;</span>]))),</span>
<span id="cb94-14"><a href="functions.html#cb94-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb94-15"><a href="functions.html#cb94-15" aria-hidden="true" tabindex="-1"></a>                          y<span class="sc">$</span>Clone<span class="ot">&lt;-</span><span class="fu">factor</span>(y<span class="sc">$</span>Clone,<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">as.character</span>(y<span class="sc">$</span>Clone)))</span>
<span id="cb94-16"><a href="functions.html#cb94-16" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">return</span>(<span class="fu">data.frame</span>(y))})</span>
<span id="cb94-17"><a href="functions.html#cb94-17" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span>(<span class="fu">class</span>(test2)<span class="sc">==</span><span class="st">&quot;list&quot;</span>){y <span class="ot">&lt;-</span> <span class="fu">lapply</span>(test2,data.frame) <span class="sc">%&gt;%</span> <span class="fu">reduce</span>(full_join, <span class="at">by =</span> <span class="st">&quot;Clone&quot;</span>)}</span>
<span id="cb94-18"><a href="functions.html#cb94-18" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span>(<span class="fu">class</span>(test2)<span class="sc">==</span><span class="st">&quot;array&quot;</span>){y <span class="ot">&lt;-</span> <span class="fu">apply</span>(test2,<span class="dv">3</span>,data.frame) <span class="sc">%&gt;%</span> <span class="fu">reduce</span>(full_join, <span class="at">by =</span> <span class="st">&quot;Clone&quot;</span>)}</span>
<span id="cb94-19"><a href="functions.html#cb94-19" aria-hidden="true" tabindex="-1"></a>                        y[<span class="fu">is.na</span>(y)]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-20"><a href="functions.html#cb94-20" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rownames</span>(y)<span class="ot">&lt;-</span>y[,<span class="st">&quot;Clone&quot;</span>]</span>
<span id="cb94-21"><a href="functions.html#cb94-21" aria-hidden="true" tabindex="-1"></a>                        y<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(y[,<span class="sc">-</span><span class="dv">2</span>])</span>
<span id="cb94-22"><a href="functions.html#cb94-22" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mode</span>(y)<span class="ot">&lt;-</span><span class="st">&#39;numeric&#39;</span></span>
<span id="cb94-23"><a href="functions.html#cb94-23" aria-hidden="true" tabindex="-1"></a>                        z<span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">apply</span>(y,<span class="dv">1</span>,<span class="cf">function</span>(p){<span class="fu">quantile</span>(p,<span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.975</span>))}))</span>
<span id="cb94-24"><a href="functions.html#cb94-24" aria-hidden="true" tabindex="-1"></a>                        z_mat<span class="ot">&lt;-</span><span class="fu">data.frame</span>(z,<span class="st">&quot;Clone&quot;</span><span class="ot">=</span><span class="fu">rownames</span>(z))</span>
<span id="cb94-25"><a href="functions.html#cb94-25" aria-hidden="true" tabindex="-1"></a>                        set<span class="ot">&lt;-</span><span class="fu">setNames</span>(<span class="fu">data.frame</span>(<span class="fu">full_join</span>(<span class="fu">data.frame</span>(clonal_abundance[[sample_to_test]]),z_mat,<span class="at">by=</span><span class="st">&quot;Clone&quot;</span>)),<span class="fu">c</span>(<span class="st">&quot;Count&quot;</span>,<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;LCI&quot;</span>,<span class="st">&quot;UCI&quot;</span>))<span class="sc">%&gt;%</span><span class="fu">filter</span>(LCI<span class="sc">&gt;=</span>clone_cutoff<span class="sc">&amp;!</span><span class="fu">is.na</span>(Count))</span>
<span id="cb94-26"><a href="functions.html#cb94-26" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">return</span>(set)</span>
<span id="cb94-27"><a href="functions.html#cb94-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-28"><a href="functions.html#cb94-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-29"><a href="functions.html#cb94-29" aria-hidden="true" tabindex="-1"></a>bootstrap_allele_dropout_NGT_mat <span class="ot">&lt;-</span> <span class="cf">function</span>(NGT_to_clone_list,clonal_abundance,sample_to_test,replicates,clone_cutoff){</span>
<span id="cb94-30"><a href="functions.html#cb94-30" aria-hidden="true" tabindex="-1"></a>                  mat_of_interest <span class="ot">&lt;-</span> NGT_to_clone[[sample_to_test]][,<span class="dv">1</span><span class="sc">:</span>(<span class="fu">ncol</span>(NGT_to_clone[[sample_to_test]])<span class="sc">-</span><span class="dv">1</span>)]</span>
<span id="cb94-31"><a href="functions.html#cb94-31" aria-hidden="true" tabindex="-1"></a>                  bulk_VAF_order <span class="ot">&lt;-</span><span class="fu">names</span>(<span class="fu">sort</span>(<span class="fu">colSums</span>(mat_of_interest),<span class="at">decreasing=</span><span class="cn">TRUE</span>))</span>
<span id="cb94-32"><a href="functions.html#cb94-32" aria-hidden="true" tabindex="-1"></a>                  test<span class="ot">&lt;-</span><span class="fu">replicate</span>(<span class="at">n=</span>replicates,<span class="fu">apply</span>(mat_of_interest,<span class="at">MARGIN=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="cf">function</span>(x){</span>
<span id="cb94-33"><a href="functions.html#cb94-33" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>(x<span class="sc">==</span><span class="dv">1</span>){z<span class="ot">&lt;-</span>x} </span>
<span id="cb94-34"><a href="functions.html#cb94-34" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>(x<span class="sc">==</span><span class="dv">0</span>){z<span class="ot">&lt;-</span><span class="fu">sample</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">size=</span><span class="dv">1</span>,<span class="at">prob=</span><span class="fu">c</span>(<span class="fl">0.9</span>,<span class="fl">0.1</span>))}</span>
<span id="cb94-35"><a href="functions.html#cb94-35" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>(x<span class="sc">==</span><span class="dv">2</span>){z<span class="ot">&lt;-</span><span class="fu">sample</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>),<span class="at">size=</span><span class="dv">1</span>,<span class="at">prob=</span><span class="fu">c</span>(<span class="fl">0.9</span>,<span class="fl">0.1</span>))}</span>
<span id="cb94-36"><a href="functions.html#cb94-36" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">return</span>(<span class="fu">as.numeric</span>(z))}),<span class="at">simplify =</span> <span class="st">&quot;array&quot;</span>)</span>
<span id="cb94-37"><a href="functions.html#cb94-37" aria-hidden="true" tabindex="-1"></a>                  test2<span class="ot">&lt;-</span><span class="fu">apply</span>(test,<span class="dv">3</span>,<span class="cf">function</span>(q){</span>
<span id="cb94-38"><a href="functions.html#cb94-38" aria-hidden="true" tabindex="-1"></a>                    x<span class="ot">&lt;-</span><span class="fu">data.frame</span>(q[,bulk_VAF_order],</span>
<span id="cb94-39"><a href="functions.html#cb94-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;Clone&quot;</span><span class="ot">=</span><span class="fu">apply</span>(q[,bulk_VAF_order],<span class="dv">1</span>, <span class="cf">function</span>(p){<span class="fu">paste</span>(p,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)}))</span>
<span id="cb94-40"><a href="functions.html#cb94-40" aria-hidden="true" tabindex="-1"></a>                    y<span class="ot">&lt;-</span><span class="fu">data.table</span>(<span class="fu">data.frame</span>(<span class="st">&quot;Count&quot;</span><span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">table</span>(x[,<span class="st">&quot;Clone&quot;</span>])),</span>
<span id="cb94-41"><a href="functions.html#cb94-41" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">&quot;Clone&quot;</span><span class="ot">=</span><span class="fu">names</span>(<span class="fu">table</span>(x[,<span class="st">&quot;Clone&quot;</span>]))),</span>
<span id="cb94-42"><a href="functions.html#cb94-42" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb94-43"><a href="functions.html#cb94-43" aria-hidden="true" tabindex="-1"></a>                    y<span class="sc">$</span>Clone<span class="ot">&lt;-</span><span class="fu">factor</span>(y<span class="sc">$</span>Clone,<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">as.character</span>(y<span class="sc">$</span>Clone)))</span>
<span id="cb94-44"><a href="functions.html#cb94-44" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">return</span>(<span class="fu">data.frame</span>(y))})</span>
<span id="cb94-45"><a href="functions.html#cb94-45" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb94-46"><a href="functions.html#cb94-46" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span>(<span class="fu">class</span>(test2)<span class="sc">==</span><span class="st">&quot;list&quot;</span>){y <span class="ot">&lt;-</span> <span class="fu">lapply</span>(test2,data.frame) <span class="sc">%&gt;%</span> <span class="fu">reduce</span>(full_join, <span class="at">by =</span> <span class="st">&quot;Clone&quot;</span>)}</span>
<span id="cb94-47"><a href="functions.html#cb94-47" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span>(<span class="fu">class</span>(test2)<span class="sc">==</span><span class="st">&quot;array&quot;</span>){y <span class="ot">&lt;-</span> <span class="fu">apply</span>(test2,<span class="dv">3</span>,data.frame) <span class="sc">%&gt;%</span> <span class="fu">reduce</span>(full_join, <span class="at">by =</span> <span class="st">&quot;Clone&quot;</span>)}</span>
<span id="cb94-48"><a href="functions.html#cb94-48" aria-hidden="true" tabindex="-1"></a>                  y[<span class="fu">is.na</span>(y)]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-49"><a href="functions.html#cb94-49" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rownames</span>(y)<span class="ot">&lt;-</span>y[,<span class="st">&quot;Clone&quot;</span>]</span>
<span id="cb94-50"><a href="functions.html#cb94-50" aria-hidden="true" tabindex="-1"></a>                  y<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(y[,<span class="sc">-</span><span class="dv">2</span>])</span>
<span id="cb94-51"><a href="functions.html#cb94-51" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mode</span>(y)<span class="ot">&lt;-</span><span class="st">&#39;numeric&#39;</span></span>
<span id="cb94-52"><a href="functions.html#cb94-52" aria-hidden="true" tabindex="-1"></a>                  z<span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">apply</span>(y,<span class="dv">1</span>,<span class="cf">function</span>(p){<span class="fu">quantile</span>(p,<span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.975</span>))}))</span>
<span id="cb94-53"><a href="functions.html#cb94-53" aria-hidden="true" tabindex="-1"></a>                  z_mat<span class="ot">&lt;-</span><span class="fu">data.frame</span>(z,<span class="st">&quot;Clone&quot;</span><span class="ot">=</span><span class="fu">rownames</span>(z))</span>
<span id="cb94-54"><a href="functions.html#cb94-54" aria-hidden="true" tabindex="-1"></a>                  set<span class="ot">&lt;-</span><span class="fu">setNames</span>(<span class="fu">data.frame</span>(<span class="fu">full_join</span>(<span class="fu">data.frame</span>(clonal_abundance[[sample_to_test]]),z_mat,<span class="at">by=</span><span class="st">&quot;Clone&quot;</span>)),<span class="fu">c</span>(<span class="st">&quot;Count&quot;</span>,<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;LCI&quot;</span>,<span class="st">&quot;UCI&quot;</span>))<span class="sc">%&gt;%</span><span class="fu">filter</span>(LCI<span class="sc">&gt;=</span>clone_cutoff<span class="sc">&amp;!</span><span class="fu">is.na</span>(Count))</span>
<span id="cb94-55"><a href="functions.html#cb94-55" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">return</span>(set)</span>
<span id="cb94-56"><a href="functions.html#cb94-56" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb94-57"><a href="functions.html#cb94-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-58"><a href="functions.html#cb94-58" aria-hidden="true" tabindex="-1"></a>bootstrap_NGT_mat <span class="ot">&lt;-</span> <span class="cf">function</span>(NGT_to_clone_list,clonal_abundance,sample_to_test,replicates,clone_cutoff){</span>
<span id="cb94-59"><a href="functions.html#cb94-59" aria-hidden="true" tabindex="-1"></a>  test<span class="ot">&lt;-</span><span class="fu">replicate</span>(<span class="at">n=</span>replicates,<span class="fu">resample_fun</span>(NGT_to_clone[[sample_to_test]]),<span class="at">simplify =</span> <span class="st">&quot;array&quot;</span>)</span>
<span id="cb94-60"><a href="functions.html#cb94-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">class</span>(test)<span class="sc">==</span><span class="st">&quot;list&quot;</span>){</span>
<span id="cb94-61"><a href="functions.html#cb94-61" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">lapply</span>(test,data.frame) <span class="sc">%&gt;%</span> <span class="fu">reduce</span>(full_join, <span class="at">by =</span> <span class="st">&quot;Clone&quot;</span>)</span>
<span id="cb94-62"><a href="functions.html#cb94-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-63"><a href="functions.html#cb94-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">class</span>(test)<span class="sc">==</span><span class="st">&quot;array&quot;</span>){</span>
<span id="cb94-64"><a href="functions.html#cb94-64" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">apply</span>(test,<span class="dv">3</span>,data.frame) <span class="sc">%&gt;%</span> <span class="fu">reduce</span>(full_join, <span class="at">by =</span> <span class="st">&quot;Clone&quot;</span>)</span>
<span id="cb94-65"><a href="functions.html#cb94-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-66"><a href="functions.html#cb94-66" aria-hidden="true" tabindex="-1"></a>  y[<span class="fu">is.na</span>(y)]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-67"><a href="functions.html#cb94-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(y)<span class="ot">&lt;-</span>y[,<span class="st">&quot;Clone&quot;</span>]</span>
<span id="cb94-68"><a href="functions.html#cb94-68" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(y[,<span class="sc">-</span><span class="dv">2</span>])</span>
<span id="cb94-69"><a href="functions.html#cb94-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mode</span>(y)<span class="ot">&lt;-</span><span class="st">&#39;numeric&#39;</span></span>
<span id="cb94-70"><a href="functions.html#cb94-70" aria-hidden="true" tabindex="-1"></a>  z<span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">apply</span>(y,<span class="dv">1</span>,<span class="cf">function</span>(p){</span>
<span id="cb94-71"><a href="functions.html#cb94-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(p,<span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.975</span>))</span>
<span id="cb94-72"><a href="functions.html#cb94-72" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb94-73"><a href="functions.html#cb94-73" aria-hidden="true" tabindex="-1"></a>  z_mat<span class="ot">&lt;-</span><span class="fu">data.frame</span>(z,<span class="st">&quot;Clone&quot;</span><span class="ot">=</span><span class="fu">rownames</span>(z))</span>
<span id="cb94-74"><a href="functions.html#cb94-74" aria-hidden="true" tabindex="-1"></a>  set<span class="ot">&lt;-</span><span class="fu">setNames</span>(<span class="fu">data.frame</span>(<span class="fu">inner_join</span>(<span class="fu">data.frame</span>(clonal_abundance[[sample_to_test]]),z_mat,<span class="at">by=</span><span class="st">&quot;Clone&quot;</span>)),<span class="fu">c</span>(<span class="st">&quot;Count&quot;</span>,<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;LCI&quot;</span>,<span class="st">&quot;UCI&quot;</span>))<span class="sc">%&gt;%</span><span class="fu">filter</span>(LCI<span class="sc">&gt;=</span>clone_cutoff)</span>
<span id="cb94-75"><a href="functions.html#cb94-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(set)</span>
<span id="cb94-76"><a href="functions.html#cb94-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-77"><a href="functions.html#cb94-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-78"><a href="functions.html#cb94-78" aria-hidden="true" tabindex="-1"></a>resample_fun<span class="ot">&lt;-</span><span class="cf">function</span>(data){</span>
<span id="cb94-79"><a href="functions.html#cb94-79" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data[<span class="fu">sample</span>(<span class="at">x=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data),<span class="at">replace=</span><span class="cn">TRUE</span>),]</span>
<span id="cb94-80"><a href="functions.html#cb94-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.matrix</span>(<span class="fu">data.table</span>(<span class="fu">data.frame</span>(<span class="st">&quot;Count&quot;</span><span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">table</span>(x[,<span class="st">&quot;Clone&quot;</span>])),</span>
<span id="cb94-81"><a href="functions.html#cb94-81" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">&quot;Clone&quot;</span><span class="ot">=</span><span class="fu">names</span>(<span class="fu">table</span>(x[,<span class="st">&quot;Clone&quot;</span>]))),</span>
<span id="cb94-82"><a href="functions.html#cb94-82" aria-hidden="true" tabindex="-1"></a>                              <span class="at">key=</span><span class="st">&quot;Count&quot;</span>)))</span>
<span id="cb94-83"><a href="functions.html#cb94-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-84"><a href="functions.html#cb94-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-85"><a href="functions.html#cb94-85" aria-hidden="true" tabindex="-1"></a>extract_NGT_files <span class="ot">&lt;-</span> <span class="cf">function</span>(sample,variants){</span>
<span id="cb94-86"><a href="functions.html#cb94-86" aria-hidden="true" tabindex="-1"></a>  NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-87"><a href="functions.html#cb94-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(NGT)</span>
<span id="cb94-88"><a href="functions.html#cb94-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-89"><a href="functions.html#cb94-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-90"><a href="functions.html#cb94-90" aria-hidden="true" tabindex="-1"></a>count_unknown_cells<span class="ot">&lt;-</span> <span class="cf">function</span>(sample,variants){</span>
<span id="cb94-91"><a href="functions.html#cb94-91" aria-hidden="true" tabindex="-1"></a>    NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-92"><a href="functions.html#cb94-92" aria-hidden="true" tabindex="-1"></a>    cells_with_unknown<span class="ot">&lt;-</span>NGT[<span class="fu">apply</span>(NGT[,variants],<span class="at">MARGIN=</span><span class="dv">1</span>,<span class="at">FUN=</span><span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">==</span><span class="dv">3</span>)<span class="sc">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb94-93"><a href="functions.html#cb94-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(<span class="fu">length</span>(cells_with_unknown)<span class="sc">/</span><span class="fu">nrow</span>(NGT)))</span>
<span id="cb94-94"><a href="functions.html#cb94-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-95"><a href="functions.html#cb94-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-96"><a href="functions.html#cb94-96" aria-hidden="true" tabindex="-1"></a>extract_DP_files <span class="ot">&lt;-</span> <span class="cf">function</span>(sample,variants){</span>
<span id="cb94-97"><a href="functions.html#cb94-97" aria-hidden="true" tabindex="-1"></a>  DP <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-98"><a href="functions.html#cb94-98" aria-hidden="true" tabindex="-1"></a>  cells_with_unknown<span class="ot">&lt;-</span>DP[<span class="fu">apply</span>(DP[,variants],<span class="at">MARGIN=</span><span class="dv">1</span>,<span class="at">FUN=</span><span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">==</span><span class="dv">3</span>)<span class="sc">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb94-99"><a href="functions.html#cb94-99" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="ot">&lt;-</span>DP[<span class="sc">!</span>DP<span class="sc">$</span>Cell<span class="sc">%in%</span>cells_with_unknown,variants]</span>
<span id="cb94-100"><a href="functions.html#cb94-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(matrix_of_interest)</span>
<span id="cb94-101"><a href="functions.html#cb94-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-102"><a href="functions.html#cb94-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-103"><a href="functions.html#cb94-103" aria-hidden="true" tabindex="-1"></a>extract_SNP_info <span class="ot">&lt;-</span> <span class="cf">function</span>(sample){</span>
<span id="cb94-104"><a href="functions.html#cb94-104" aria-hidden="true" tabindex="-1"></a>  AF <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                  </span>
<span id="cb94-105"><a href="functions.html#cb94-105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-106"><a href="functions.html#cb94-106" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-107"><a href="functions.html#cb94-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-108"><a href="functions.html#cb94-108" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-109"><a href="functions.html#cb94-109" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-110"><a href="functions.html#cb94-110" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-111"><a href="functions.html#cb94-111" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-112"><a href="functions.html#cb94-112" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb94-113"><a href="functions.html#cb94-113" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-114"><a href="functions.html#cb94-114" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-115"><a href="functions.html#cb94-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-116"><a href="functions.html#cb94-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(SNP_INFO)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;protein&quot;</span></span>
<span id="cb94-117"><a href="functions.html#cb94-117" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>cDNA <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>cDNA)</span>
<span id="cb94-118"><a href="functions.html#cb94-118" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>protein)</span>
<span id="cb94-119"><a href="functions.html#cb94-119" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Variant <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Variant)</span>
<span id="cb94-120"><a href="functions.html#cb94-120" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Gene <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Gene)</span>
<span id="cb94-121"><a href="functions.html#cb94-121" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-122"><a href="functions.html#cb94-122" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-123"><a href="functions.html#cb94-123" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-124"><a href="functions.html#cb94-124" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-125"><a href="functions.html#cb94-125" aria-hidden="true" tabindex="-1"></a>     }) </span>
<span id="cb94-126"><a href="functions.html#cb94-126" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-127"><a href="functions.html#cb94-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(SNP_INFO)</span>
<span id="cb94-128"><a href="functions.html#cb94-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-129"><a href="functions.html#cb94-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-130"><a href="functions.html#cb94-130" aria-hidden="true" tabindex="-1"></a><span class="co"># run the following just once to load the function</span></span>
<span id="cb94-131"><a href="functions.html#cb94-131" aria-hidden="true" tabindex="-1"></a>plot_variants_and_selection <span class="ot">&lt;-</span> <span class="cf">function</span>(sample){</span>
<span id="cb94-132"><a href="functions.html#cb94-132" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Load in the data</span></span>
<span id="cb94-133"><a href="functions.html#cb94-133" aria-hidden="true" tabindex="-1"></a>  AF <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb94-134"><a href="functions.html#cb94-134" aria-hidden="true" tabindex="-1"></a>  DP <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb94-135"><a href="functions.html#cb94-135" aria-hidden="true" tabindex="-1"></a>  GQ <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb94-136"><a href="functions.html#cb94-136" aria-hidden="true" tabindex="-1"></a>  NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb94-137"><a href="functions.html#cb94-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-138"><a href="functions.html#cb94-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-139"><a href="functions.html#cb94-139" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-140"><a href="functions.html#cb94-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-141"><a href="functions.html#cb94-141" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-142"><a href="functions.html#cb94-142" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-143"><a href="functions.html#cb94-143" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-144"><a href="functions.html#cb94-144" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-145"><a href="functions.html#cb94-145" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-146"><a href="functions.html#cb94-146" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-147"><a href="functions.html#cb94-147" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-148"><a href="functions.html#cb94-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-149"><a href="functions.html#cb94-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(SNP_INFO)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;protein&quot;</span></span>
<span id="cb94-150"><a href="functions.html#cb94-150" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>cDNA <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>cDNA)</span>
<span id="cb94-151"><a href="functions.html#cb94-151" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>protein)</span>
<span id="cb94-152"><a href="functions.html#cb94-152" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Variant <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Variant)</span>
<span id="cb94-153"><a href="functions.html#cb94-153" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Gene <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Gene)</span>
<span id="cb94-154"><a href="functions.html#cb94-154" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-155"><a href="functions.html#cb94-155" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-156"><a href="functions.html#cb94-156" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-157"><a href="functions.html#cb94-157" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-158"><a href="functions.html#cb94-158" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-159"><a href="functions.html#cb94-159" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-160"><a href="functions.html#cb94-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-161"><a href="functions.html#cb94-161" aria-hidden="true" tabindex="-1"></a>  protein_changes_of_interest <span class="ot">&lt;-</span> (SNP_INFO <span class="sc">%&gt;%</span> <span class="fu">filter</span>(protein<span class="sc">!=</span><span class="st">&quot;&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(protein))[,<span class="dv">1</span>] <span class="co"># select column of variants</span></span>
<span id="cb94-162"><a href="functions.html#cb94-162" aria-hidden="true" tabindex="-1"></a>  SNP_changes_of_interest <span class="ot">&lt;-</span> <span class="fu">rownames</span>(SNP_INFO)[SNP_INFO[,<span class="st">&quot;protein&quot;</span>]<span class="sc">%in%</span>protein_changes_of_interest]</span>
<span id="cb94-163"><a href="functions.html#cb94-163" aria-hidden="true" tabindex="-1"></a>  SNP_protein_key <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Mutant&quot;</span><span class="ot">=</span>SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span><span class="ot">=</span>protein_changes_of_interest)</span>
<span id="cb94-164"><a href="functions.html#cb94-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-165"><a href="functions.html#cb94-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cell and clone selection and Average depth per cell per allele</span></span>
<span id="cb94-166"><a href="functions.html#cb94-166" aria-hidden="true" tabindex="-1"></a>  distribution_of_unknowns_by_variant <span class="ot">&lt;-</span> <span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb94-167"><a href="functions.html#cb94-167" aria-hidden="true" tabindex="-1"></a>  NGT_subset<span class="ot">&lt;-</span>NGT[,<span class="fu">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>,SNP_changes_of_interest)]</span>
<span id="cb94-168"><a href="functions.html#cb94-168" aria-hidden="true" tabindex="-1"></a>  <span class="co">#NGT_interest$Clone &lt;- apply(NGT_interest[,-c(1,2)],1,function(x){paste(x,sep=&quot;_&quot;,collapse=&quot;_&quot;)})</span></span>
<span id="cb94-169"><a href="functions.html#cb94-169" aria-hidden="true" tabindex="-1"></a>  <span class="co">#clonal_abundance &lt;- sort(table(NGT_interest$Clone))</span></span>
<span id="cb94-170"><a href="functions.html#cb94-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-171"><a href="functions.html#cb94-171" aria-hidden="true" tabindex="-1"></a>  DP_subset<span class="ot">&lt;-</span> DP[,<span class="fu">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>,SNP_changes_of_interest)]</span>
<span id="cb94-172"><a href="functions.html#cb94-172" aria-hidden="true" tabindex="-1"></a>  DP_NGT_melt<span class="ot">&lt;-</span><span class="fu">inner_join</span>(<span class="fu">melt</span>(DP_subset[,<span class="sc">-</span><span class="dv">1</span>],<span class="at">id.var=</span><span class="st">&quot;Cell&quot;</span>),<span class="fu">melt</span>(NGT_subset[,<span class="sc">-</span><span class="dv">1</span>],<span class="at">id.var=</span><span class="st">&quot;Cell&quot;</span>),<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;variable&quot;</span>))</span>
<span id="cb94-173"><a href="functions.html#cb94-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(DP_NGT_melt) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Depth&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb94-174"><a href="functions.html#cb94-174" aria-hidden="true" tabindex="-1"></a>  DP_NGT_melt<span class="sc">$</span>Genotype <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(DP_NGT_melt<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">3</span>,<span class="st">&quot;Unknown&quot;</span>,</span>
<span id="cb94-175"><a href="functions.html#cb94-175" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">ifelse</span>(DP_NGT_melt<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb94-176"><a href="functions.html#cb94-176" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">ifelse</span>(DP_NGT_melt<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb94-177"><a href="functions.html#cb94-177" aria-hidden="true" tabindex="-1"></a>                                               <span class="fu">ifelse</span>(DP_NGT_melt<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,DP_NGT_melt<span class="sc">$</span>Genotype))))</span>
<span id="cb94-178"><a href="functions.html#cb94-178" aria-hidden="true" tabindex="-1"></a>  DP_NGT_melt<span class="sc">$</span>Genotype  <span class="ot">&lt;-</span> <span class="fu">factor</span>(DP_NGT_melt<span class="sc">$</span>Genotype ,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>,<span class="st">&quot;Unknown&quot;</span>))</span>
<span id="cb94-179"><a href="functions.html#cb94-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-180"><a href="functions.html#cb94-180" aria-hidden="true" tabindex="-1"></a>  summarized<span class="ot">&lt;-</span><span class="fu">data.frame</span>(DP_NGT_melt<span class="sc">%&gt;%</span><span class="fu">group_by</span>(Mutant,Genotype)<span class="sc">%&gt;%</span><span class="fu">summarise</span>(<span class="st">&quot;Depth&quot;</span><span class="ot">=</span><span class="fu">mean</span>(Depth)))</span>
<span id="cb94-181"><a href="functions.html#cb94-181" aria-hidden="true" tabindex="-1"></a>  summarized_no_unknown <span class="ot">&lt;-</span> summarized <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Genotype<span class="sc">!=</span><span class="st">&quot;Unknown&quot;</span>)</span>
<span id="cb94-182"><a href="functions.html#cb94-182" aria-hidden="true" tabindex="-1"></a>  grouped <span class="ot">&lt;-</span> <span class="fu">group_by</span>(summarized_no_unknown, Mutant)</span>
<span id="cb94-183"><a href="functions.html#cb94-183" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">summarise</span>(grouped, <span class="at">mean=</span><span class="fu">mean</span>(Depth), <span class="at">sd=</span><span class="fu">sd</span>(Depth))) </span>
<span id="cb94-184"><a href="functions.html#cb94-184" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>Include <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;Include&quot;</span>,<span class="fu">length</span>(<span class="fu">rownames</span>(output)))</span>
<span id="cb94-185"><a href="functions.html#cb94-185" aria-hidden="true" tabindex="-1"></a>  output_final <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(SNP_protein_key,output)</span>
<span id="cb94-186"><a href="functions.html#cb94-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-187"><a href="functions.html#cb94-187" aria-hidden="true" tabindex="-1"></a>  depth_plot<span class="ot">&lt;-</span> <span class="fu">ggplot</span>(summarized_no_unknown,<span class="fu">aes</span>(<span class="at">x=</span>Mutant,<span class="at">y=</span>Depth,<span class="at">color=</span>Genotype))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">coord_flip</span>()<span class="sc">+</span></span>
<span id="cb94-188"><a href="functions.html#cb94-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">limits =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(summarized_no_unknown<span class="sc">$</span>Mutant)))<span class="sc">+</span><span class="fu">theme_bw</span>()<span class="co">#+</span></span>
<span id="cb94-189"><a href="functions.html#cb94-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-190"><a href="functions.html#cb94-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(output_final,<span class="fu">paste0</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION.csv&quot;</span>),<span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb94-191"><a href="functions.html#cb94-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION.pdf&quot;</span>),depth_plot,<span class="at">width=</span><span class="dv">10</span>,<span class="at">height=</span><span class="dv">20</span>)</span>
<span id="cb94-192"><a href="functions.html#cb94-192" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-193"><a href="functions.html#cb94-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-194"><a href="functions.html#cb94-194" aria-hidden="true" tabindex="-1"></a>run_mbio_analysis<span class="ot">&lt;-</span><span class="cf">function</span>(sample,diversity){</span>
<span id="cb94-195"><a href="functions.html#cb94-195" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Load in the data</span></span>
<span id="cb94-196"><a href="functions.html#cb94-196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-197"><a href="functions.html#cb94-197" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-198"><a href="functions.html#cb94-198" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_MAT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-199"><a href="functions.html#cb94-199" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_SNP <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb94-200"><a href="functions.html#cb94-200" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_Protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb94-201"><a href="functions.html#cb94-201" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-202"><a href="functions.html#cb94-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb94-203"><a href="functions.html#cb94-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb94-204"><a href="functions.html#cb94-204" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-205"><a href="functions.html#cb94-205" aria-hidden="true" tabindex="-1"></a>  AF <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb94-206"><a href="functions.html#cb94-206" aria-hidden="true" tabindex="-1"></a>  DP <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb94-207"><a href="functions.html#cb94-207" aria-hidden="true" tabindex="-1"></a>  GQ <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb94-208"><a href="functions.html#cb94-208" aria-hidden="true" tabindex="-1"></a>  NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb94-209"><a href="functions.html#cb94-209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-210"><a href="functions.html#cb94-210" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-211"><a href="functions.html#cb94-211" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-212"><a href="functions.html#cb94-212" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-213"><a href="functions.html#cb94-213" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-214"><a href="functions.html#cb94-214" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-215"><a href="functions.html#cb94-215" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-216"><a href="functions.html#cb94-216" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-217"><a href="functions.html#cb94-217" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-218"><a href="functions.html#cb94-218" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-219"><a href="functions.html#cb94-219" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-220"><a href="functions.html#cb94-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-221"><a href="functions.html#cb94-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(SNP_INFO)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;protein&quot;</span></span>
<span id="cb94-222"><a href="functions.html#cb94-222" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>cDNA <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>cDNA)</span>
<span id="cb94-223"><a href="functions.html#cb94-223" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>protein)</span>
<span id="cb94-224"><a href="functions.html#cb94-224" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Variant <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Variant)</span>
<span id="cb94-225"><a href="functions.html#cb94-225" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Gene <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Gene)</span>
<span id="cb94-226"><a href="functions.html#cb94-226" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-227"><a href="functions.html#cb94-227" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-228"><a href="functions.html#cb94-228" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-229"><a href="functions.html#cb94-229" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-230"><a href="functions.html#cb94-230" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-231"><a href="functions.html#cb94-231" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-232"><a href="functions.html#cb94-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-233"><a href="functions.html#cb94-233" aria-hidden="true" tabindex="-1"></a>  SNP_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_SNP</span>
<span id="cb94-234"><a href="functions.html#cb94-234" aria-hidden="true" tabindex="-1"></a>  protein_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_Protein</span>
<span id="cb94-235"><a href="functions.html#cb94-235" aria-hidden="true" tabindex="-1"></a>  SNP_protein_key <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Mutant&quot;</span><span class="ot">=</span>SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span><span class="ot">=</span>protein_changes_of_interest)</span>
<span id="cb94-236"><a href="functions.html#cb94-236" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-237"><a href="functions.html#cb94-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cell and clone selection</span></span>
<span id="cb94-238"><a href="functions.html#cb94-238" aria-hidden="true" tabindex="-1"></a>  distribution_of_unknowns_by_variant <span class="ot">&lt;-</span> <span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb94-239"><a href="functions.html#cb94-239" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb94-240"><a href="functions.html#cb94-240" aria-hidden="true" tabindex="-1"></a>  cells_with_unknown<span class="ot">&lt;-</span>NGT[<span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">1</span>,<span class="at">FUN=</span><span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">==</span><span class="dv">3</span>)<span class="sc">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb94-241"><a href="functions.html#cb94-241" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="ot">&lt;-</span>NGT[<span class="sc">!</span>NGT<span class="sc">$</span>Cell<span class="sc">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb94-242"><a href="functions.html#cb94-242" aria-hidden="true" tabindex="-1"></a>  bulk_VAF_order<span class="ot">&lt;-</span>SNP_INFO[<span class="fu">colnames</span>(matrix_of_interest)[<span class="fu">order</span>(<span class="fu">colSums</span>(matrix_of_interest),<span class="at">decreasing=</span><span class="cn">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb94-243"><a href="functions.html#cb94-243" aria-hidden="true" tabindex="-1"></a>  bulk_VAF_order <span class="ot">&lt;-</span> bulk_VAF_order[<span class="sc">!</span><span class="fu">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb94-244"><a href="functions.html#cb94-244" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-245"><a href="functions.html#cb94-245" aria-hidden="true" tabindex="-1"></a>  clonal_abundance <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">table</span>(matrix_of_interest<span class="sc">$</span>Clone))</span>
<span id="cb94-246"><a href="functions.html#cb94-246" aria-hidden="true" tabindex="-1"></a>  clones_to_include<span class="ot">&lt;-</span><span class="fu">names</span>(clonal_abundance)[clonal_abundance<span class="sc">&gt;</span><span class="fu">length</span>(<span class="fu">rownames</span>(matrix_of_interest))<span class="sc">*</span><span class="dv">0</span>]</span>
<span id="cb94-247"><a href="functions.html#cb94-247" aria-hidden="true" tabindex="-1"></a>  matrix_subset_clones <span class="ot">&lt;-</span> matrix_of_interest[matrix_of_interest<span class="sc">$</span>Clone<span class="sc">%in%</span>clones_to_include,]</span>
<span id="cb94-248"><a href="functions.html#cb94-248" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-249"><a href="functions.html#cb94-249" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Average depth per cell per allele</span></span>
<span id="cb94-250"><a href="functions.html#cb94-250" aria-hidden="true" tabindex="-1"></a>  DP_subset<span class="ot">&lt;-</span> DP[<span class="sc">-</span>cells_with_unknown,<span class="fu">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>,<span class="fu">rownames</span>(SNP_INFO)[SNP_INFO<span class="sc">$</span>protein<span class="sc">%in%</span>protein_changes_of_interest])]</span>
<span id="cb94-251"><a href="functions.html#cb94-251" aria-hidden="true" tabindex="-1"></a>  NGT_subset <span class="ot">&lt;-</span> NGT[NGT<span class="sc">$</span>Cell<span class="sc">%in%</span>DP_subset<span class="sc">$</span>Cell,<span class="fu">colnames</span>(DP_subset)]</span>
<span id="cb94-252"><a href="functions.html#cb94-252" aria-hidden="true" tabindex="-1"></a>  DP_NGT_melt<span class="ot">&lt;-</span><span class="fu">inner_join</span>(<span class="fu">melt</span>(DP_subset[,<span class="sc">-</span><span class="dv">1</span>],<span class="at">id.var=</span><span class="st">&quot;Cell&quot;</span>),<span class="fu">melt</span>(NGT[,<span class="sc">-</span><span class="dv">1</span>],<span class="at">id.var=</span><span class="st">&quot;Cell&quot;</span>),<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;variable&quot;</span>))</span>
<span id="cb94-253"><a href="functions.html#cb94-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(DP_NGT_melt) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Depth&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb94-254"><a href="functions.html#cb94-254" aria-hidden="true" tabindex="-1"></a>  DP_NGT_melt<span class="sc">$</span>Genotype <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(DP_NGT_melt<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">3</span>,<span class="st">&quot;Unknown&quot;</span>,</span>
<span id="cb94-255"><a href="functions.html#cb94-255" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">ifelse</span>(DP_NGT_melt<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb94-256"><a href="functions.html#cb94-256" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">ifelse</span>(DP_NGT_melt<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb94-257"><a href="functions.html#cb94-257" aria-hidden="true" tabindex="-1"></a>                                               <span class="fu">ifelse</span>(DP_NGT_melt<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,DP_NGT_melt<span class="sc">$</span>Genotype))))</span>
<span id="cb94-258"><a href="functions.html#cb94-258" aria-hidden="true" tabindex="-1"></a>  DP_NGT_melt<span class="sc">$</span>Genotype  <span class="ot">&lt;-</span> <span class="fu">factor</span>(DP_NGT_melt<span class="sc">$</span>Genotype ,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>,<span class="st">&quot;Unknown&quot;</span>))</span>
<span id="cb94-259"><a href="functions.html#cb94-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-260"><a href="functions.html#cb94-260" aria-hidden="true" tabindex="-1"></a>  summarized<span class="ot">&lt;-</span><span class="fu">data.frame</span>(DP_NGT_melt<span class="sc">%&gt;%</span><span class="fu">group_by</span>(Mutant,Genotype)<span class="sc">%&gt;%</span><span class="fu">summarise</span>(<span class="st">&quot;Depth&quot;</span><span class="ot">=</span><span class="fu">mean</span>(Depth)))</span>
<span id="cb94-261"><a href="functions.html#cb94-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-262"><a href="functions.html#cb94-262" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-263"><a href="functions.html#cb94-263" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Verify variants selected are unique and encode protein changes</span></span>
<span id="cb94-264"><a href="functions.html#cb94-264" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">any</span>(<span class="fu">duplicated</span>(SNP_INFO[<span class="fu">colnames</span>(matrix_subset_clones),<span class="st">&quot;protein&quot;</span>])) <span class="co">#Should return TRUE</span></span>
<span id="cb94-265"><a href="functions.html#cb94-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(matrix_subset_clones)<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">as.character</span>(SNP_INFO[<span class="fu">colnames</span>(matrix_subset_clones)[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(SNP_changes_of_interest)],<span class="st">&quot;protein&quot;</span>]),<span class="st">&quot;Clone&quot;</span>)</span>
<span id="cb94-266"><a href="functions.html#cb94-266" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-267"><a href="functions.html#cb94-267" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate data to get clone counts and architecture.</span></span>
<span id="cb94-268"><a href="functions.html#cb94-268" aria-hidden="true" tabindex="-1"></a>  dedup<span class="ot">&lt;-</span>matrix_subset_clones[<span class="sc">!</span><span class="fu">duplicated</span>(matrix_subset_clones),]</span>
<span id="cb94-269"><a href="functions.html#cb94-269" aria-hidden="true" tabindex="-1"></a>  clonal_architecture <span class="ot">&lt;-</span> <span class="fu">melt</span>(dedup)</span>
<span id="cb94-270"><a href="functions.html#cb94-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(clonal_architecture) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb94-271"><a href="functions.html#cb94-271" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Genotype <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">3</span>,<span class="cn">NA</span>,</span>
<span id="cb94-272"><a href="functions.html#cb94-272" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb94-273"><a href="functions.html#cb94-273" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb94-274"><a href="functions.html#cb94-274" aria-hidden="true" tabindex="-1"></a>                                                       <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,clonal_architecture<span class="sc">$</span>Genotype))))</span>
<span id="cb94-275"><a href="functions.html#cb94-275" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Genotype  <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_architecture<span class="sc">$</span>Genotype ,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>))</span>
<span id="cb94-276"><a href="functions.html#cb94-276" aria-hidden="true" tabindex="-1"></a>  clonal_abundance <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Count&quot;</span><span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">table</span>(matrix_subset_clones<span class="sc">$</span>Clone)))</span>
<span id="cb94-277"><a href="functions.html#cb94-277" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">rownames</span>(clonal_abundance)</span>
<span id="cb94-278"><a href="functions.html#cb94-278" aria-hidden="true" tabindex="-1"></a>  clonal_abundance <span class="ot">&lt;-</span> <span class="fu">data.table</span>(clonal_abundance,<span class="at">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb94-279"><a href="functions.html#cb94-279" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_abundance<span class="sc">$</span>Clone,<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">c</span>(clonal_abundance<span class="sc">$</span>Clone)))</span>
<span id="cb94-280"><a href="functions.html#cb94-280" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">as.character</span>(clonal_architecture<span class="sc">$</span>Clone),<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">as.character</span>(clonal_abundance<span class="sc">$</span>Clone)))</span>
<span id="cb94-281"><a href="functions.html#cb94-281" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Mutant <span class="ot">&lt;-</span><span class="fu">factor</span>(clonal_architecture<span class="sc">$</span>Mutant , <span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">as.character</span>(bulk_VAF_order)))</span>
<span id="cb94-282"><a href="functions.html#cb94-282" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-283"><a href="functions.html#cb94-283" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate clonal architecture heatmap</span></span>
<span id="cb94-284"><a href="functions.html#cb94-284" aria-hidden="true" tabindex="-1"></a>  gg_heatmap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> clonal_architecture, <span class="fu">aes</span>(<span class="at">x =</span> Clone, <span class="at">y =</span> <span class="fu">factor</span>(Mutant), <span class="at">fill =</span> Genotype)) <span class="sc">+</span> </span>
<span id="cb94-285"><a href="functions.html#cb94-285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span> </span>
<span id="cb94-286"><a href="functions.html#cb94-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb94-287"><a href="functions.html#cb94-287" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Heterozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb94-288"><a href="functions.html#cb94-288" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Homozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb94-289"><a href="functions.html#cb94-289" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Unknown&quot;</span><span class="ot">=</span><span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="sc">+</span></span>
<span id="cb94-290"><a href="functions.html#cb94-290" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb94-291"><a href="functions.html#cb94-291" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-292"><a href="functions.html#cb94-292" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="at">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb94-293"><a href="functions.html#cb94-293" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb94-294"><a href="functions.html#cb94-294" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-295"><a href="functions.html#cb94-295" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-296"><a href="functions.html#cb94-296" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb94-297"><a href="functions.html#cb94-297" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-298"><a href="functions.html#cb94-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-299"><a href="functions.html#cb94-299" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb94-300"><a href="functions.html#cb94-300" aria-hidden="true" tabindex="-1"></a>  gg_clonal_barplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(clonal_abundance), <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Clone), <span class="at">y =</span> Count)) <span class="sc">+</span> </span>
<span id="cb94-301"><a href="functions.html#cb94-301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="fu">aes</span>(<span class="at">fill =</span> Count)) <span class="sc">+</span> <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb94-302"><a href="functions.html#cb94-302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb94-303"><a href="functions.html#cb94-303" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fu">max</span>(clonal_abundance<span class="sc">$</span>Count)<span class="sc">*</span><span class="fl">1.3</span>) <span class="sc">+</span> </span>
<span id="cb94-304"><a href="functions.html#cb94-304" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-305"><a href="functions.html#cb94-305" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>Count), <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.9</span>), <span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.25</span>)<span class="sc">+</span></span>
<span id="cb94-306"><a href="functions.html#cb94-306" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_distiller</span>(<span class="at">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;Reds&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb94-307"><a href="functions.html#cb94-307" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),  <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-308"><a href="functions.html#cb94-308" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb94-309"><a href="functions.html#cb94-309" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="sc">-</span><span class="fl">0.2</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-310"><a href="functions.html#cb94-310" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-311"><a href="functions.html#cb94-311" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate genotype calls by allele</span></span>
<span id="cb94-312"><a href="functions.html#cb94-312" aria-hidden="true" tabindex="-1"></a>  distribution_of_unknowns_by_variant <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">2</span>,<span class="cf">function</span>(x){<span class="fu">table</span>(<span class="fu">factor</span>(x,<span class="at">levels=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)))}))</span>
<span id="cb94-313"><a href="functions.html#cb94-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(distribution_of_unknowns_by_variant) <span class="ot">&lt;-</span> SNP_INFO[<span class="fu">rownames</span>(distribution_of_unknowns_by_variant),<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb94-314"><a href="functions.html#cb94-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(distribution_of_unknowns_by_variant) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>,<span class="st">&quot;Unknown&quot;</span>)</span>
<span id="cb94-315"><a href="functions.html#cb94-315" aria-hidden="true" tabindex="-1"></a>  allele_melted <span class="ot">&lt;-</span><span class="fu">melt</span>(distribution_of_unknowns_by_variant) </span>
<span id="cb94-316"><a href="functions.html#cb94-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(allele_melted) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>,<span class="st">&quot;Cells&quot;</span>)</span>
<span id="cb94-317"><a href="functions.html#cb94-317" aria-hidden="true" tabindex="-1"></a>  allele_melted<span class="sc">$</span>Genotype <span class="ot">&lt;-</span> <span class="fu">factor</span>(allele_melted<span class="sc">$</span>Genotype,<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>,<span class="st">&quot;Unknown&quot;</span>)))</span>
<span id="cb94-318"><a href="functions.html#cb94-318" aria-hidden="true" tabindex="-1"></a>  allele_melted<span class="sc">$</span>Mutant <span class="ot">&lt;-</span><span class="fu">factor</span>(allele_melted<span class="sc">$</span>Mutant , <span class="at">levels=</span><span class="fu">as.character</span>(bulk_VAF_order))</span>
<span id="cb94-319"><a href="functions.html#cb94-319" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-320"><a href="functions.html#cb94-320" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Generate allele barplot</span></span>
<span id="cb94-321"><a href="functions.html#cb94-321" aria-hidden="true" tabindex="-1"></a>  gg_alleles <span class="ot">&lt;-</span>  <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(allele_melted), <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Mutant), <span class="at">y =</span> Cells)) <span class="sc">+</span> </span>
<span id="cb94-322"><a href="functions.html#cb94-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="fu">aes</span>(<span class="at">fill =</span> Genotype),<span class="at">position=</span><span class="st">&quot;stack&quot;</span>) <span class="sc">+</span> <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb94-323"><a href="functions.html#cb94-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb94-324"><a href="functions.html#cb94-324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-325"><a href="functions.html#cb94-325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb94-326"><a href="functions.html#cb94-326" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Heterozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb94-327"><a href="functions.html#cb94-327" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Homozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb94-328"><a href="functions.html#cb94-328" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Unknown&quot;</span><span class="ot">=</span><span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>) <span class="sc">+</span></span>
<span id="cb94-329"><a href="functions.html#cb94-329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">30</span>,<span class="at">hjust=</span><span class="dv">1</span>,<span class="at">vjust=</span><span class="dv">1</span>))</span>
<span id="cb94-330"><a href="functions.html#cb94-330" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-331"><a href="functions.html#cb94-331" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-332"><a href="functions.html#cb94-332" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Generate depth by alelle by mutant                       </span></span>
<span id="cb94-333"><a href="functions.html#cb94-333" aria-hidden="true" tabindex="-1"></a>  gg_depth <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(summarized,<span class="fu">aes</span>(<span class="at">x=</span>Mutant,<span class="at">color=</span>Genotype,<span class="at">y=</span>Depth))<span class="sc">+</span></span>
<span id="cb94-334"><a href="functions.html#cb94-334" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb94-335"><a href="functions.html#cb94-335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb94-336"><a href="functions.html#cb94-336" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;Heterozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb94-337"><a href="functions.html#cb94-337" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;Homozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb94-338"><a href="functions.html#cb94-338" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;Unknown&quot;</span><span class="ot">=</span><span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>) <span class="sc">+</span></span>
<span id="cb94-339"><a href="functions.html#cb94-339" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">30</span>,<span class="at">hjust=</span><span class="dv">1</span>,<span class="at">vjust=</span><span class="dv">1</span>),</span>
<span id="cb94-340"><a href="functions.html#cb94-340" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-341"><a href="functions.html#cb94-341" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-342"><a href="functions.html#cb94-342" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute spacing of graphs</span></span>
<span id="cb94-343"><a href="functions.html#cb94-343" aria-hidden="true" tabindex="-1"></a>  plots <span class="ot">&lt;-</span> <span class="fu">list</span>(gg_depth,gg_clonal_barplot,gg_alleles,gg_heatmap)</span>
<span id="cb94-344"><a href="functions.html#cb94-344" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb94-345"><a href="functions.html#cb94-345" aria-hidden="true" tabindex="-1"></a>  widths <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb94-346"><a href="functions.html#cb94-346" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(plots)){</span>
<span id="cb94-347"><a href="functions.html#cb94-347" aria-hidden="true" tabindex="-1"></a>    grobs[[i]] <span class="ot">&lt;-</span> <span class="fu">ggplotGrob</span>(plots[[i]])</span>
<span id="cb94-348"><a href="functions.html#cb94-348" aria-hidden="true" tabindex="-1"></a>    widths[[i]] <span class="ot">&lt;-</span> grobs[[i]]<span class="sc">$</span>widths[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb94-349"><a href="functions.html#cb94-349" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-350"><a href="functions.html#cb94-350" aria-hidden="true" tabindex="-1"></a>  maxwidth <span class="ot">&lt;-</span> <span class="fu">do.call</span>(grid<span class="sc">::</span>unit.pmax, widths)</span>
<span id="cb94-351"><a href="functions.html#cb94-351" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(grobs)){</span>
<span id="cb94-352"><a href="functions.html#cb94-352" aria-hidden="true" tabindex="-1"></a>    grobs[[i]]<span class="sc">$</span>widths[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="fu">as.list</span>(maxwidth)</span>
<span id="cb94-353"><a href="functions.html#cb94-353" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-354"><a href="functions.html#cb94-354" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-355"><a href="functions.html#cb94-355" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate plot</span></span>
<span id="cb94-356"><a href="functions.html#cb94-356" aria-hidden="true" tabindex="-1"></a>  grob.title <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(sample, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">20</span>))</span>
<span id="cb94-357"><a href="functions.html#cb94-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pdf</span>(<span class="fu">paste</span>(output_folder,<span class="st">&quot;Graphs/&quot;</span>,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>), <span class="at">width =</span> <span class="dv">16</span>, <span class="at">height =</span> <span class="dv">8</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb94-358"><a href="functions.html#cb94-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grid.arrange</span>(<span class="at">grobs=</span>grobs, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">top =</span> grob.title)</span>
<span id="cb94-359"><a href="functions.html#cb94-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">graphics.off</span>()</span>
<span id="cb94-360"><a href="functions.html#cb94-360" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-361"><a href="functions.html#cb94-361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-362"><a href="functions.html#cb94-362" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(diversity<span class="sc">==</span><span class="cn">TRUE</span>){</span>
<span id="cb94-363"><a href="functions.html#cb94-363" aria-hidden="true" tabindex="-1"></a>    clonal_abundance_mat <span class="ot">&lt;-</span> clonal_abundance</span>
<span id="cb94-364"><a href="functions.html#cb94-364" aria-hidden="true" tabindex="-1"></a>    clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">rownames</span>(clonal_abundance)</span>
<span id="cb94-365"><a href="functions.html#cb94-365" aria-hidden="true" tabindex="-1"></a>    clonal_abundance_mat<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">rownames</span>(clonal_abundance_mat)</span>
<span id="cb94-366"><a href="functions.html#cb94-366" aria-hidden="true" tabindex="-1"></a>    clonal_abundance_count <span class="ot">&lt;-</span> <span class="fu">data.table</span>(clonal_abundance,<span class="at">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb94-367"><a href="functions.html#cb94-367" aria-hidden="true" tabindex="-1"></a>    shannon <span class="ot">&lt;-</span> <span class="fu">diversity</span>(clonal_abundance_mat[,<span class="st">&quot;Count&quot;</span>])</span>
<span id="cb94-368"><a href="functions.html#cb94-368" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv2</span>(shannon,<span class="fu">paste</span>(output_folder,<span class="st">&quot;Diversity_score/&quot;</span>,sample,<span class="st">&quot;.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))</span>
<span id="cb94-369"><a href="functions.html#cb94-369" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-370"><a href="functions.html#cb94-370" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-371"><a href="functions.html#cb94-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-372"><a href="functions.html#cb94-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-373"><a href="functions.html#cb94-373" aria-hidden="true" tabindex="-1"></a>stats_output<span class="ot">&lt;-</span><span class="cf">function</span>(sample){</span>
<span id="cb94-374"><a href="functions.html#cb94-374" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Load in the data</span></span>
<span id="cb94-375"><a href="functions.html#cb94-375" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-376"><a href="functions.html#cb94-376" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-377"><a href="functions.html#cb94-377" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_MAT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-378"><a href="functions.html#cb94-378" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_SNP <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb94-379"><a href="functions.html#cb94-379" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_Protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb94-380"><a href="functions.html#cb94-380" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-381"><a href="functions.html#cb94-381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb94-382"><a href="functions.html#cb94-382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb94-383"><a href="functions.html#cb94-383" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-384"><a href="functions.html#cb94-384" aria-hidden="true" tabindex="-1"></a>  AF <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb94-385"><a href="functions.html#cb94-385" aria-hidden="true" tabindex="-1"></a>  DP <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb94-386"><a href="functions.html#cb94-386" aria-hidden="true" tabindex="-1"></a>  GQ <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb94-387"><a href="functions.html#cb94-387" aria-hidden="true" tabindex="-1"></a>  NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb94-388"><a href="functions.html#cb94-388" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-389"><a href="functions.html#cb94-389" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-390"><a href="functions.html#cb94-390" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-391"><a href="functions.html#cb94-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-392"><a href="functions.html#cb94-392" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-393"><a href="functions.html#cb94-393" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-394"><a href="functions.html#cb94-394" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-395"><a href="functions.html#cb94-395" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-396"><a href="functions.html#cb94-396" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-397"><a href="functions.html#cb94-397" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-398"><a href="functions.html#cb94-398" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-399"><a href="functions.html#cb94-399" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-400"><a href="functions.html#cb94-400" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(SNP_INFO)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;protein&quot;</span></span>
<span id="cb94-401"><a href="functions.html#cb94-401" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>cDNA <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>cDNA)</span>
<span id="cb94-402"><a href="functions.html#cb94-402" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>protein)</span>
<span id="cb94-403"><a href="functions.html#cb94-403" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Variant <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Variant)</span>
<span id="cb94-404"><a href="functions.html#cb94-404" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Gene <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Gene)</span>
<span id="cb94-405"><a href="functions.html#cb94-405" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-406"><a href="functions.html#cb94-406" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-407"><a href="functions.html#cb94-407" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-408"><a href="functions.html#cb94-408" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-409"><a href="functions.html#cb94-409" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-410"><a href="functions.html#cb94-410" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-411"><a href="functions.html#cb94-411" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-412"><a href="functions.html#cb94-412" aria-hidden="true" tabindex="-1"></a>  SNP_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_SNP</span>
<span id="cb94-413"><a href="functions.html#cb94-413" aria-hidden="true" tabindex="-1"></a>  protein_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_Protein</span>
<span id="cb94-414"><a href="functions.html#cb94-414" aria-hidden="true" tabindex="-1"></a>  SNP_protein_key <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Mutant&quot;</span><span class="ot">=</span>SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span><span class="ot">=</span>protein_changes_of_interest)</span>
<span id="cb94-415"><a href="functions.html#cb94-415" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-416"><a href="functions.html#cb94-416" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cell and clone selection</span></span>
<span id="cb94-417"><a href="functions.html#cb94-417" aria-hidden="true" tabindex="-1"></a>  distribution_of_unknowns_by_variant <span class="ot">&lt;-</span> <span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb94-418"><a href="functions.html#cb94-418" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb94-419"><a href="functions.html#cb94-419" aria-hidden="true" tabindex="-1"></a>  cells_with_unknown<span class="ot">&lt;-</span>NGT[<span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">1</span>,<span class="at">FUN=</span><span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">==</span><span class="dv">3</span>)<span class="sc">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb94-420"><a href="functions.html#cb94-420" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="ot">&lt;-</span>NGT[<span class="sc">!</span>NGT<span class="sc">$</span>Cell<span class="sc">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb94-421"><a href="functions.html#cb94-421" aria-hidden="true" tabindex="-1"></a>  bulk_VAF_order<span class="ot">&lt;-</span>SNP_INFO[<span class="fu">colnames</span>(matrix_of_interest)[<span class="fu">order</span>(<span class="fu">colSums</span>(matrix_of_interest),<span class="at">decreasing=</span><span class="cn">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb94-422"><a href="functions.html#cb94-422" aria-hidden="true" tabindex="-1"></a>  bulk_VAF_order <span class="ot">&lt;-</span> bulk_VAF_order[<span class="sc">!</span><span class="fu">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb94-423"><a href="functions.html#cb94-423" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-424"><a href="functions.html#cb94-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-425"><a href="functions.html#cb94-425" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate data to get clone counts and architecture.</span></span>
<span id="cb94-426"><a href="functions.html#cb94-426" aria-hidden="true" tabindex="-1"></a>  dedup<span class="ot">&lt;-</span>matrix_of_interest[<span class="sc">!</span><span class="fu">duplicated</span>(matrix_of_interest),]</span>
<span id="cb94-427"><a href="functions.html#cb94-427" aria-hidden="true" tabindex="-1"></a>  clonal_abundance <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Count&quot;</span><span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">table</span>(matrix_of_interest<span class="sc">$</span>Clone)))</span>
<span id="cb94-428"><a href="functions.html#cb94-428" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span>  <span class="fu">factor</span>(<span class="fu">rownames</span>(clonal_abundance),<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">c</span>(<span class="fu">rownames</span>(clonal_abundance))))</span>
<span id="cb94-429"><a href="functions.html#cb94-429" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Count <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(clonal_abundance<span class="sc">$</span>Count)</span>
<span id="cb94-430"><a href="functions.html#cb94-430" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Dominance <span class="ot">&lt;-</span> <span class="fu">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-431"><a href="functions.html#cb94-431" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">as.numeric</span>(x[<span class="st">&quot;Count&quot;</span>])<span class="sc">/</span><span class="fu">sum</span>(clonal_abundance[<span class="st">&quot;Count&quot;</span>]) ) <span class="sc">/</span> (<span class="fu">max</span>(<span class="fu">as.numeric</span>(clonal_abundance[,<span class="st">&quot;Count&quot;</span>]))<span class="sc">/</span><span class="fu">sum</span>(clonal_abundance[<span class="st">&quot;Count&quot;</span>]))</span>
<span id="cb94-432"><a href="functions.html#cb94-432" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb94-433"><a href="functions.html#cb94-433" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Mutation_count <span class="ot">&lt;-</span> <span class="fu">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-434"><a href="functions.html#cb94-434" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">as.numeric</span>(<span class="fu">strsplit</span>( <span class="fu">as.character</span>(x[<span class="dv">2</span>]),<span class="at">split=</span><span class="st">&quot;_&quot;</span>)[[<span class="dv">1</span>]]))</span>
<span id="cb94-435"><a href="functions.html#cb94-435" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb94-436"><a href="functions.html#cb94-436" aria-hidden="true" tabindex="-1"></a>  shannon <span class="ot">&lt;-</span> <span class="fu">diversity</span>(clonal_abundance[,<span class="st">&quot;Count&quot;</span>])</span>
<span id="cb94-437"><a href="functions.html#cb94-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(shannon)</span>
<span id="cb94-438"><a href="functions.html#cb94-438" aria-hidden="true" tabindex="-1"></a>  matrix_output <span class="ot">&lt;-</span> dedup<span class="sc">%&gt;%</span><span class="fu">select</span>(<span class="sc">-</span>Clone)</span>
<span id="cb94-439"><a href="functions.html#cb94-439" aria-hidden="true" tabindex="-1"></a>  matrix_output_t <span class="ot">&lt;-</span> <span class="fu">t</span>(matrix_output)</span>
<span id="cb94-440"><a href="functions.html#cb94-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(matrix_output_t) <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">dim</span>(matrix_output_t)[[<span class="dv">1</span>]]<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb94-441"><a href="functions.html#cb94-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(shannon,<span class="fu">paste0</span>(output_folder,<span class="st">&quot;Diversity_score/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb94-442"><a href="functions.html#cb94-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(matrix_output_t,<span class="fu">paste0</span>(output_folder,<span class="st">&quot;Genotype_matrix/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="at">sep=</span><span class="st">&quot; &quot;</span>,<span class="at">row.names=</span><span class="cn">TRUE</span>,<span class="at">quote=</span><span class="cn">FALSE</span>,<span class="at">col.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb94-443"><a href="functions.html#cb94-443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(clonal_abundance,<span class="fu">paste0</span>(output_folder,<span class="st">&quot;Summary_mat/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb94-444"><a href="functions.html#cb94-444" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-445"><a href="functions.html#cb94-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-446"><a href="functions.html#cb94-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-447"><a href="functions.html#cb94-447" aria-hidden="true" tabindex="-1"></a>permute_data <span class="ot">&lt;-</span> <span class="cf">function</span>(sample,nrun){</span>
<span id="cb94-448"><a href="functions.html#cb94-448" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Load in the data</span></span>
<span id="cb94-449"><a href="functions.html#cb94-449" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-450"><a href="functions.html#cb94-450" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-451"><a href="functions.html#cb94-451" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_MAT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-452"><a href="functions.html#cb94-452" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_SNP <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb94-453"><a href="functions.html#cb94-453" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_Protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb94-454"><a href="functions.html#cb94-454" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-455"><a href="functions.html#cb94-455" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb94-456"><a href="functions.html#cb94-456" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb94-457"><a href="functions.html#cb94-457" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-458"><a href="functions.html#cb94-458" aria-hidden="true" tabindex="-1"></a>  AF <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb94-459"><a href="functions.html#cb94-459" aria-hidden="true" tabindex="-1"></a>  DP <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb94-460"><a href="functions.html#cb94-460" aria-hidden="true" tabindex="-1"></a>  GQ <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb94-461"><a href="functions.html#cb94-461" aria-hidden="true" tabindex="-1"></a>  NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb94-462"><a href="functions.html#cb94-462" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-463"><a href="functions.html#cb94-463" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-464"><a href="functions.html#cb94-464" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-465"><a href="functions.html#cb94-465" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-466"><a href="functions.html#cb94-466" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-467"><a href="functions.html#cb94-467" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-468"><a href="functions.html#cb94-468" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-469"><a href="functions.html#cb94-469" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-470"><a href="functions.html#cb94-470" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-471"><a href="functions.html#cb94-471" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-472"><a href="functions.html#cb94-472" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-473"><a href="functions.html#cb94-473" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-474"><a href="functions.html#cb94-474" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(SNP_INFO)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;protein&quot;</span></span>
<span id="cb94-475"><a href="functions.html#cb94-475" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>cDNA <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>cDNA)</span>
<span id="cb94-476"><a href="functions.html#cb94-476" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>protein)</span>
<span id="cb94-477"><a href="functions.html#cb94-477" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Variant <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Variant)</span>
<span id="cb94-478"><a href="functions.html#cb94-478" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Gene <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Gene)</span>
<span id="cb94-479"><a href="functions.html#cb94-479" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-480"><a href="functions.html#cb94-480" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-481"><a href="functions.html#cb94-481" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-482"><a href="functions.html#cb94-482" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-483"><a href="functions.html#cb94-483" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-484"><a href="functions.html#cb94-484" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-485"><a href="functions.html#cb94-485" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-486"><a href="functions.html#cb94-486" aria-hidden="true" tabindex="-1"></a>  SNP_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_SNP</span>
<span id="cb94-487"><a href="functions.html#cb94-487" aria-hidden="true" tabindex="-1"></a>  protein_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_Protein</span>
<span id="cb94-488"><a href="functions.html#cb94-488" aria-hidden="true" tabindex="-1"></a>  SNP_protein_key <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Mutant&quot;</span><span class="ot">=</span>SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span><span class="ot">=</span>protein_changes_of_interest)</span>
<span id="cb94-489"><a href="functions.html#cb94-489" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-490"><a href="functions.html#cb94-490" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cell and clone selection</span></span>
<span id="cb94-491"><a href="functions.html#cb94-491" aria-hidden="true" tabindex="-1"></a>  distribution_of_unknowns_by_variant <span class="ot">&lt;-</span> <span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb94-492"><a href="functions.html#cb94-492" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb94-493"><a href="functions.html#cb94-493" aria-hidden="true" tabindex="-1"></a>  cells_with_unknown<span class="ot">&lt;-</span>NGT[<span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">1</span>,<span class="at">FUN=</span><span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">==</span><span class="dv">3</span>)<span class="sc">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb94-494"><a href="functions.html#cb94-494" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="ot">&lt;-</span>NGT[<span class="sc">!</span>NGT<span class="sc">$</span>Cell<span class="sc">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb94-495"><a href="functions.html#cb94-495" aria-hidden="true" tabindex="-1"></a>  bulk_VAF_order<span class="ot">&lt;-</span>SNP_INFO[<span class="fu">colnames</span>(matrix_of_interest)[<span class="fu">order</span>(<span class="fu">colSums</span>(matrix_of_interest),<span class="at">decreasing=</span><span class="cn">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb94-496"><a href="functions.html#cb94-496" aria-hidden="true" tabindex="-1"></a>  bulk_VAF_order <span class="ot">&lt;-</span> bulk_VAF_order[<span class="sc">!</span><span class="fu">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb94-497"><a href="functions.html#cb94-497" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-498"><a href="functions.html#cb94-498" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-499"><a href="functions.html#cb94-499" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate data to get clone counts and architecture.</span></span>
<span id="cb94-500"><a href="functions.html#cb94-500" aria-hidden="true" tabindex="-1"></a>  dedup<span class="ot">&lt;-</span>matrix_of_interest[<span class="sc">!</span><span class="fu">duplicated</span>(matrix_of_interest),]</span>
<span id="cb94-501"><a href="functions.html#cb94-501" aria-hidden="true" tabindex="-1"></a>  clonal_abundance <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Count&quot;</span><span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">table</span>(matrix_of_interest<span class="sc">$</span>Clone)))</span>
<span id="cb94-502"><a href="functions.html#cb94-502" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span>  <span class="fu">factor</span>(<span class="fu">rownames</span>(clonal_abundance),<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">c</span>(<span class="fu">rownames</span>(clonal_abundance))))</span>
<span id="cb94-503"><a href="functions.html#cb94-503" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Count <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(clonal_abundance<span class="sc">$</span>Count)</span>
<span id="cb94-504"><a href="functions.html#cb94-504" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-505"><a href="functions.html#cb94-505" aria-hidden="true" tabindex="-1"></a>  clonal_architecture <span class="ot">&lt;-</span> <span class="fu">melt</span>(dedup)</span>
<span id="cb94-506"><a href="functions.html#cb94-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(clonal_architecture) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb94-507"><a href="functions.html#cb94-507" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Genotype <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">3</span>,<span class="cn">NA</span>,</span>
<span id="cb94-508"><a href="functions.html#cb94-508" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb94-509"><a href="functions.html#cb94-509" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb94-510"><a href="functions.html#cb94-510" aria-hidden="true" tabindex="-1"></a>                                                       <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,clonal_architecture<span class="sc">$</span>Genotype))))</span>
<span id="cb94-511"><a href="functions.html#cb94-511" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Genotype  <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_architecture<span class="sc">$</span>Genotype ,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>))</span>
<span id="cb94-512"><a href="functions.html#cb94-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-513"><a href="functions.html#cb94-513" aria-hidden="true" tabindex="-1"></a>  results_holder <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span>nrun))</span>
<span id="cb94-514"><a href="functions.html#cb94-514" aria-hidden="true" tabindex="-1"></a>  randomization_list<span class="ot">&lt;-</span><span class="fu">lapply</span>(results_holder,<span class="cf">function</span>(x){</span>
<span id="cb94-515"><a href="functions.html#cb94-515" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(matrix_of_interest[,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">colnames</span>(matrix_of_interest))<span class="sc">-</span><span class="dv">1</span>],<span class="dv">2</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-516"><a href="functions.html#cb94-516" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> <span class="fu">sample</span>(x,<span class="fu">length</span>(x),<span class="at">replace=</span><span class="cn">FALSE</span>)</span>
<span id="cb94-517"><a href="functions.html#cb94-517" aria-hidden="true" tabindex="-1"></a>    })})</span>
<span id="cb94-518"><a href="functions.html#cb94-518" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-519"><a href="functions.html#cb94-519" aria-hidden="true" tabindex="-1"></a>  <span class="co">#randomization_list&lt;-plyr::alply(randomization_array,3)</span></span>
<span id="cb94-520"><a href="functions.html#cb94-520" aria-hidden="true" tabindex="-1"></a>  <span class="co"># names(randomization_list) &lt;- NULL</span></span>
<span id="cb94-521"><a href="functions.html#cb94-521" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-522"><a href="functions.html#cb94-522" aria-hidden="true" tabindex="-1"></a>  empirical_distribution<span class="ot">&lt;-</span><span class="fu">suppressMessages</span>(<span class="fu">lapply</span>(randomization_list, <span class="cf">function</span>(randomization){</span>
<span id="cb94-523"><a href="functions.html#cb94-523" aria-hidden="true" tabindex="-1"></a>    randomization<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">apply</span>(randomization,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-524"><a href="functions.html#cb94-524" aria-hidden="true" tabindex="-1"></a>    loop_dedup<span class="ot">&lt;-</span>matrix_of_interest[<span class="sc">!</span><span class="fu">duplicated</span>(randomization),]</span>
<span id="cb94-525"><a href="functions.html#cb94-525" aria-hidden="true" tabindex="-1"></a>    loop_clonal_architecture <span class="ot">&lt;-</span> <span class="fu">melt</span>(loop_dedup)</span>
<span id="cb94-526"><a href="functions.html#cb94-526" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(loop_clonal_architecture) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb94-527"><a href="functions.html#cb94-527" aria-hidden="true" tabindex="-1"></a>    loop_clonal_architecture<span class="sc">$</span>Genotype <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(loop_clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">3</span>,<span class="cn">NA</span>,</span>
<span id="cb94-528"><a href="functions.html#cb94-528" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">ifelse</span>(loop_clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb94-529"><a href="functions.html#cb94-529" aria-hidden="true" tabindex="-1"></a>                                                       <span class="fu">ifelse</span>(loop_clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb94-530"><a href="functions.html#cb94-530" aria-hidden="true" tabindex="-1"></a>                                                              <span class="fu">ifelse</span>(loop_clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,clonal_architecture<span class="sc">$</span>Genotype))))</span>
<span id="cb94-531"><a href="functions.html#cb94-531" aria-hidden="true" tabindex="-1"></a>    loop_clonal_architecture<span class="sc">$</span>Genotype  <span class="ot">&lt;-</span> <span class="fu">factor</span>(loop_clonal_architecture<span class="sc">$</span>Genotype ,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>))</span>
<span id="cb94-532"><a href="functions.html#cb94-532" aria-hidden="true" tabindex="-1"></a>    loop_clonal_abundance <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Count&quot;</span><span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">table</span>(randomization<span class="sc">$</span>Clone)))</span>
<span id="cb94-533"><a href="functions.html#cb94-533" aria-hidden="true" tabindex="-1"></a>    loop_clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">rownames</span>(loop_clonal_abundance)</span>
<span id="cb94-534"><a href="functions.html#cb94-534" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(loop_clonal_abundance))</span>
<span id="cb94-535"><a href="functions.html#cb94-535" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb94-536"><a href="functions.html#cb94-536" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-537"><a href="functions.html#cb94-537" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-538"><a href="functions.html#cb94-538" aria-hidden="true" tabindex="-1"></a>  empirical_distribution_mat<span class="ot">&lt;-</span>empirical_distribution<span class="sc">%&gt;%</span>purrr<span class="sc">::</span><span class="fu">reduce</span>(dplyr<span class="sc">::</span>full_join,<span class="at">by=</span><span class="st">&quot;Clone&quot;</span>)</span>
<span id="cb94-539"><a href="functions.html#cb94-539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(empirical_distribution_mat)<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">colnames</span>(empirical_distribution_mat))</span>
<span id="cb94-540"><a href="functions.html#cb94-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(empirical_distribution_mat) <span class="ot">&lt;-</span> empirical_distribution_mat[,<span class="dv">2</span>]</span>
<span id="cb94-541"><a href="functions.html#cb94-541" aria-hidden="true" tabindex="-1"></a>  empirical_distribution_mat <span class="ot">&lt;-</span> empirical_distribution_mat[,<span class="sc">-</span><span class="dv">2</span>]</span>
<span id="cb94-542"><a href="functions.html#cb94-542" aria-hidden="true" tabindex="-1"></a>  empirical_distribution_mat[<span class="fu">is.na</span>(empirical_distribution_mat)]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-543"><a href="functions.html#cb94-543" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-544"><a href="functions.html#cb94-544" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">as.character</span>(clonal_abundance<span class="sc">$</span>Clone)</span>
<span id="cb94-545"><a href="functions.html#cb94-545" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Count <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(clonal_abundance<span class="sc">$</span>Count)</span>
<span id="cb94-546"><a href="functions.html#cb94-546" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>pvalue <span class="ot">&lt;-</span><span class="fu">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-547"><a href="functions.html#cb94-547" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">-</span>  <span class="fu">sum</span>(<span class="fu">as.numeric</span>(x[[<span class="st">&quot;Count&quot;</span>]])<span class="sc">&gt;</span>empirical_distribution_mat[x[[<span class="st">&quot;Clone&quot;</span>]],])<span class="sc">/</span>nrun</span>
<span id="cb94-548"><a href="functions.html#cb94-548" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb94-549"><a href="functions.html#cb94-549" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-550"><a href="functions.html#cb94-550" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-551"><a href="functions.html#cb94-551" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(dedup)</span></span>
<span id="cb94-552"><a href="functions.html#cb94-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(clonal_abundance)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">colnames</span>(dedup)[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(SNP_changes_of_interest)],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;__&quot;</span>)</span>
<span id="cb94-553"><a href="functions.html#cb94-553" aria-hidden="true" tabindex="-1"></a>  clonal_abundance <span class="ot">&lt;-</span> clonal_abundance[<span class="fu">order</span>(clonal_abundance[,<span class="st">&quot;Count&quot;</span>],<span class="at">decreasing =</span> <span class="cn">TRUE</span>),]</span>
<span id="cb94-554"><a href="functions.html#cb94-554" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Dominance <span class="ot">&lt;-</span> <span class="fu">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-555"><a href="functions.html#cb94-555" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">as.numeric</span>(x[<span class="st">&quot;Count&quot;</span>])<span class="sc">/</span><span class="fu">sum</span>(clonal_abundance[<span class="st">&quot;Count&quot;</span>]) ) <span class="sc">/</span> (<span class="fu">max</span>(<span class="fu">as.numeric</span>(clonal_abundance[,<span class="st">&quot;Count&quot;</span>]))<span class="sc">/</span><span class="fu">sum</span>(clonal_abundance[<span class="st">&quot;Count&quot;</span>]))</span>
<span id="cb94-556"><a href="functions.html#cb94-556" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb94-557"><a href="functions.html#cb94-557" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Poisson <span class="ot">&lt;-</span> <span class="fu">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-558"><a href="functions.html#cb94-558" aria-hidden="true" tabindex="-1"></a>        <span class="fu">poisson.test</span>(<span class="fu">as.numeric</span>(x[<span class="st">&quot;Count&quot;</span>]),<span class="fu">mean</span>(<span class="fu">as.numeric</span>(clonal_abundance<span class="sc">$</span>Count)),<span class="at">alternative=</span><span class="st">&quot;greater&quot;</span>)<span class="sc">$</span>p.value</span>
<span id="cb94-559"><a href="functions.html#cb94-559" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb94-560"><a href="functions.html#cb94-560" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Mutation_count <span class="ot">&lt;-</span> <span class="fu">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-561"><a href="functions.html#cb94-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">as.numeric</span>(<span class="fu">strsplit</span>( <span class="fu">as.character</span>(x[<span class="dv">2</span>]),<span class="at">split=</span><span class="st">&quot;_&quot;</span>)[[<span class="dv">1</span>]]))</span>
<span id="cb94-562"><a href="functions.html#cb94-562" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb94-563"><a href="functions.html#cb94-563" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-564"><a href="functions.html#cb94-564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(clonal_abundance,<span class="fu">paste0</span>(output_folder,<span class="st">&quot;Summary_mat/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">row.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb94-565"><a href="functions.html#cb94-565" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-566"><a href="functions.html#cb94-566" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-567"><a href="functions.html#cb94-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-568"><a href="functions.html#cb94-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-569"><a href="functions.html#cb94-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-570"><a href="functions.html#cb94-570" aria-hidden="true" tabindex="-1"></a>replot_clonal_selection <span class="ot">&lt;-</span> <span class="cf">function</span>(sample){</span>
<span id="cb94-571"><a href="functions.html#cb94-571" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-572"><a href="functions.html#cb94-572" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-573"><a href="functions.html#cb94-573" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_MAT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-574"><a href="functions.html#cb94-574" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_SNP <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb94-575"><a href="functions.html#cb94-575" aria-hidden="true" tabindex="-1"></a>    LAM_VARIANTS_Protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb94-576"><a href="functions.html#cb94-576" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-577"><a href="functions.html#cb94-577" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb94-578"><a href="functions.html#cb94-578" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb94-579"><a href="functions.html#cb94-579" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-580"><a href="functions.html#cb94-580" aria-hidden="true" tabindex="-1"></a>  DP <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb94-581"><a href="functions.html#cb94-581" aria-hidden="true" tabindex="-1"></a>  NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb94-582"><a href="functions.html#cb94-582" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-583"><a href="functions.html#cb94-583" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-584"><a href="functions.html#cb94-584" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-585"><a href="functions.html#cb94-585" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(NGT)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-586"><a href="functions.html#cb94-586" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-587"><a href="functions.html#cb94-587" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-588"><a href="functions.html#cb94-588" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-589"><a href="functions.html#cb94-589" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-590"><a href="functions.html#cb94-590" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-591"><a href="functions.html#cb94-591" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-592"><a href="functions.html#cb94-592" aria-hidden="true" tabindex="-1"></a>    SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-593"><a href="functions.html#cb94-593" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(NGT)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-594"><a href="functions.html#cb94-594" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(SNP_INFO)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;protein&quot;</span></span>
<span id="cb94-595"><a href="functions.html#cb94-595" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>cDNA <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>cDNA)</span>
<span id="cb94-596"><a href="functions.html#cb94-596" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>protein)</span>
<span id="cb94-597"><a href="functions.html#cb94-597" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Variant <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Variant)</span>
<span id="cb94-598"><a href="functions.html#cb94-598" aria-hidden="true" tabindex="-1"></a>    SNP_INFO<span class="sc">$</span>Gene <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Gene)</span>
<span id="cb94-599"><a href="functions.html#cb94-599" aria-hidden="true" tabindex="-1"></a>    SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-600"><a href="functions.html#cb94-600" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-601"><a href="functions.html#cb94-601" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-602"><a href="functions.html#cb94-602" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-603"><a href="functions.html#cb94-603" aria-hidden="true" tabindex="-1"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb94-604"><a href="functions.html#cb94-604" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-605"><a href="functions.html#cb94-605" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-606"><a href="functions.html#cb94-606" aria-hidden="true" tabindex="-1"></a>  SNP_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_SNP</span>
<span id="cb94-607"><a href="functions.html#cb94-607" aria-hidden="true" tabindex="-1"></a>  protein_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_Protein</span>
<span id="cb94-608"><a href="functions.html#cb94-608" aria-hidden="true" tabindex="-1"></a>  SNP_protein_key <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Mutant&quot;</span><span class="ot">=</span>SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span><span class="ot">=</span>protein_changes_of_interest)</span>
<span id="cb94-609"><a href="functions.html#cb94-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(SNP_protein_key) <span class="ot">&lt;-</span> SNP_protein_key<span class="sc">$</span>Mutant</span>
<span id="cb94-610"><a href="functions.html#cb94-610" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cell and clone selection</span></span>
<span id="cb94-611"><a href="functions.html#cb94-611" aria-hidden="true" tabindex="-1"></a>  distribution_of_unknowns_by_variant <span class="ot">&lt;-</span> <span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb94-612"><a href="functions.html#cb94-612" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb94-613"><a href="functions.html#cb94-613" aria-hidden="true" tabindex="-1"></a>  cells_with_unknown<span class="ot">&lt;-</span>NGT[<span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">1</span>,<span class="at">FUN=</span><span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">==</span><span class="dv">3</span>)<span class="sc">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb94-614"><a href="functions.html#cb94-614" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="ot">&lt;-</span>NGT[<span class="sc">!</span>NGT<span class="sc">$</span>Cell<span class="sc">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb94-615"><a href="functions.html#cb94-615" aria-hidden="true" tabindex="-1"></a>  bulk_VAF_order<span class="ot">&lt;-</span>SNP_INFO[<span class="fu">colnames</span>(matrix_of_interest)[<span class="fu">order</span>(<span class="fu">colSums</span>(matrix_of_interest),<span class="at">decreasing=</span><span class="cn">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb94-616"><a href="functions.html#cb94-616" aria-hidden="true" tabindex="-1"></a>  bulk_VAF_order <span class="ot">&lt;-</span> bulk_VAF_order[<span class="sc">!</span><span class="fu">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb94-617"><a href="functions.html#cb94-617" aria-hidden="true" tabindex="-1"></a>  matrix_of_interest<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-618"><a href="functions.html#cb94-618" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-619"><a href="functions.html#cb94-619" aria-hidden="true" tabindex="-1"></a>  dedup<span class="ot">&lt;-</span>matrix_of_interest[<span class="sc">!</span><span class="fu">duplicated</span>(matrix_of_interest),]</span>
<span id="cb94-620"><a href="functions.html#cb94-620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(dedup) <span class="ot">&lt;-</span> SNP_protein_key[<span class="fu">colnames</span>(dedup),<span class="st">&quot;Protein&quot;</span>]</span>
<span id="cb94-621"><a href="functions.html#cb94-621" aria-hidden="true" tabindex="-1"></a>  clonal_architecture <span class="ot">&lt;-</span> <span class="fu">melt</span>(dedup)</span>
<span id="cb94-622"><a href="functions.html#cb94-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(clonal_architecture) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb94-623"><a href="functions.html#cb94-623" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Genotype <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">3</span>,<span class="cn">NA</span>,</span>
<span id="cb94-624"><a href="functions.html#cb94-624" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb94-625"><a href="functions.html#cb94-625" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb94-626"><a href="functions.html#cb94-626" aria-hidden="true" tabindex="-1"></a>                                                       <span class="fu">ifelse</span>(clonal_architecture<span class="sc">$</span>Genotype<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,clonal_architecture<span class="sc">$</span>Genotype))))</span>
<span id="cb94-627"><a href="functions.html#cb94-627" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Genotype  <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_architecture<span class="sc">$</span>Genotype ,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>))</span>
<span id="cb94-628"><a href="functions.html#cb94-628" aria-hidden="true" tabindex="-1"></a>  clonal_abundance <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Count&quot;</span><span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">table</span>(matrix_of_interest<span class="sc">$</span>Clone)))</span>
<span id="cb94-629"><a href="functions.html#cb94-629" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">rownames</span>(clonal_abundance)</span>
<span id="cb94-630"><a href="functions.html#cb94-630" aria-hidden="true" tabindex="-1"></a>  clonal_abundance <span class="ot">&lt;-</span> <span class="fu">data.table</span>(clonal_abundance,<span class="at">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb94-631"><a href="functions.html#cb94-631" aria-hidden="true" tabindex="-1"></a>  clonal_abundance<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_abundance<span class="sc">$</span>Clone,<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">c</span>(clonal_abundance<span class="sc">$</span>Clone)))</span>
<span id="cb94-632"><a href="functions.html#cb94-632" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">as.character</span>(clonal_architecture<span class="sc">$</span>Clone),<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">as.character</span>(clonal_abundance<span class="sc">$</span>Clone)))</span>
<span id="cb94-633"><a href="functions.html#cb94-633" aria-hidden="true" tabindex="-1"></a>  clonal_architecture<span class="sc">$</span>Mutant <span class="ot">&lt;-</span><span class="fu">factor</span>(clonal_architecture<span class="sc">$</span>Mutant , <span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">as.character</span>(bulk_VAF_order)))</span>
<span id="cb94-634"><a href="functions.html#cb94-634" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-635"><a href="functions.html#cb94-635" aria-hidden="true" tabindex="-1"></a>  clones_import <span class="ot">&lt;-</span> <span class="fu">read.delim</span>(<span class="fu">paste0</span>(<span class="st">&quot;/Volumes/LevineLab/Levine Lab/Bobby/Collaborations/MissionBio/08_08_19/Summary_mat/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb94-636"><a href="functions.html#cb94-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(clones_import)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Clone&quot;</span></span>
<span id="cb94-637"><a href="functions.html#cb94-637" aria-hidden="true" tabindex="-1"></a>  select_clones_full <span class="ot">&lt;-</span> clones_import <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pvalue<span class="sc">&lt;</span><span class="fl">0.1</span><span class="sc">|</span>Poisson<span class="sc">&lt;</span><span class="fl">0.05</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Clone)</span>
<span id="cb94-638"><a href="functions.html#cb94-638" aria-hidden="true" tabindex="-1"></a>  select_clones_dominant <span class="ot">&lt;-</span> clones_import <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pvalue<span class="sc">&lt;</span><span class="fl">0.1</span><span class="sc">|</span>Poisson<span class="sc">&lt;</span><span class="fl">0.05</span>)<span class="sc">%&gt;%</span><span class="fu">filter</span>(Dominance<span class="sc">&gt;</span><span class="fl">0.05</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Clone)</span>
<span id="cb94-639"><a href="functions.html#cb94-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-640"><a href="functions.html#cb94-640" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-641"><a href="functions.html#cb94-641" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-642"><a href="functions.html#cb94-642" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(select_clones_dominant[,<span class="dv">1</span>])<span class="sc">&gt;</span><span class="dv">3</span>){</span>
<span id="cb94-643"><a href="functions.html#cb94-643" aria-hidden="true" tabindex="-1"></a>    clonal_architecture_subset <span class="ot">&lt;-</span> clonal_architecture<span class="sc">%&gt;%</span><span class="fu">filter</span>(Clone<span class="sc">%in%</span>select_clones_dominant[,<span class="dv">1</span>])</span>
<span id="cb94-644"><a href="functions.html#cb94-644" aria-hidden="true" tabindex="-1"></a>    clonal_abundance_subset <span class="ot">&lt;-</span> clonal_abundance<span class="sc">%&gt;%</span><span class="fu">filter</span>(Clone<span class="sc">%in%</span>select_clones_dominant[,<span class="dv">1</span>])</span>
<span id="cb94-645"><a href="functions.html#cb94-645" aria-hidden="true" tabindex="-1"></a>    name_var <span class="ot">&lt;-</span> <span class="st">&quot;VAF Subset&quot;</span></span>
<span id="cb94-646"><a href="functions.html#cb94-646" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">length</span>(select_clones_full[,<span class="dv">1</span>])<span class="sc">&gt;</span><span class="dv">20</span>){</span>
<span id="cb94-647"><a href="functions.html#cb94-647" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;Complex clonal picture, skipping&quot;</span>)</span>
<span id="cb94-648"><a href="functions.html#cb94-648" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cf">next</span>)</span>
<span id="cb94-649"><a href="functions.html#cb94-649" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">length</span>(select_clones_full[,<span class="dv">1</span>])<span class="sc">&lt;</span><span class="dv">2</span>){</span>
<span id="cb94-650"><a href="functions.html#cb94-650" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;Simple clonal picture, plotting all clones&quot;</span>)</span>
<span id="cb94-651"><a href="functions.html#cb94-651" aria-hidden="true" tabindex="-1"></a>    clonal_architecture_subset <span class="ot">&lt;-</span> clonal_architecture</span>
<span id="cb94-652"><a href="functions.html#cb94-652" aria-hidden="true" tabindex="-1"></a>    clonal_abundance_subset <span class="ot">&lt;-</span> clonal_abundance</span>
<span id="cb94-653"><a href="functions.html#cb94-653" aria-hidden="true" tabindex="-1"></a>    name_var <span class="ot">&lt;-</span> <span class="st">&quot;All Clones&quot;</span></span>
<span id="cb94-654"><a href="functions.html#cb94-654" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-655"><a href="functions.html#cb94-655" aria-hidden="true" tabindex="-1"></a>    clonal_architecture_subset <span class="ot">&lt;-</span> clonal_architecture<span class="sc">%&gt;%</span><span class="fu">filter</span>(Clone<span class="sc">%in%</span>select_clones_full[,<span class="dv">1</span>])</span>
<span id="cb94-656"><a href="functions.html#cb94-656" aria-hidden="true" tabindex="-1"></a>    clonal_abundance_subset <span class="ot">&lt;-</span> clonal_abundance<span class="sc">%&gt;%</span><span class="fu">filter</span>(Clone<span class="sc">%in%</span>select_clones_full[,<span class="dv">1</span>])</span>
<span id="cb94-657"><a href="functions.html#cb94-657" aria-hidden="true" tabindex="-1"></a>    name_var <span class="ot">&lt;-</span> <span class="st">&quot;Full&quot;</span></span>
<span id="cb94-658"><a href="functions.html#cb94-658" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-659"><a href="functions.html#cb94-659" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate clonal architecture heatmap</span></span>
<span id="cb94-660"><a href="functions.html#cb94-660" aria-hidden="true" tabindex="-1"></a>  gg_heatmap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> clonal_architecture_subset, <span class="fu">aes</span>(<span class="at">x =</span> Clone, <span class="at">y =</span> <span class="fu">factor</span>(Mutant), <span class="at">fill =</span> Genotype)) <span class="sc">+</span> </span>
<span id="cb94-661"><a href="functions.html#cb94-661" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span> </span>
<span id="cb94-662"><a href="functions.html#cb94-662" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb94-663"><a href="functions.html#cb94-663" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Heterozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb94-664"><a href="functions.html#cb94-664" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Homozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb94-665"><a href="functions.html#cb94-665" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Unknown&quot;</span><span class="ot">=</span><span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="sc">+</span></span>
<span id="cb94-666"><a href="functions.html#cb94-666" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb94-667"><a href="functions.html#cb94-667" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-668"><a href="functions.html#cb94-668" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="at">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb94-669"><a href="functions.html#cb94-669" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb94-670"><a href="functions.html#cb94-670" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-671"><a href="functions.html#cb94-671" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-672"><a href="functions.html#cb94-672" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb94-673"><a href="functions.html#cb94-673" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-674"><a href="functions.html#cb94-674" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-675"><a href="functions.html#cb94-675" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb94-676"><a href="functions.html#cb94-676" aria-hidden="true" tabindex="-1"></a>  gg_clonal_barplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(clonal_abundance_subset), <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Clone), <span class="at">y =</span> Count)) <span class="sc">+</span> </span>
<span id="cb94-677"><a href="functions.html#cb94-677" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="fu">aes</span>(<span class="at">fill =</span> Count)) <span class="sc">+</span> <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb94-678"><a href="functions.html#cb94-678" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb94-679"><a href="functions.html#cb94-679" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fu">max</span>(clonal_abundance<span class="sc">$</span>Count)<span class="sc">*</span><span class="fl">1.3</span>) <span class="sc">+</span> </span>
<span id="cb94-680"><a href="functions.html#cb94-680" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-681"><a href="functions.html#cb94-681" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>Count), <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.9</span>), <span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.25</span>)<span class="sc">+</span></span>
<span id="cb94-682"><a href="functions.html#cb94-682" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_distiller</span>(<span class="at">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;Reds&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb94-683"><a href="functions.html#cb94-683" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),  <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-684"><a href="functions.html#cb94-684" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb94-685"><a href="functions.html#cb94-685" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="sc">-</span><span class="fl">0.2</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-686"><a href="functions.html#cb94-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-687"><a href="functions.html#cb94-687" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute spacing of graphs</span></span>
<span id="cb94-688"><a href="functions.html#cb94-688" aria-hidden="true" tabindex="-1"></a>  plots <span class="ot">&lt;-</span> <span class="fu">list</span>(gg_clonal_barplot,gg_heatmap)</span>
<span id="cb94-689"><a href="functions.html#cb94-689" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb94-690"><a href="functions.html#cb94-690" aria-hidden="true" tabindex="-1"></a>  widths <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb94-691"><a href="functions.html#cb94-691" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(plots)){</span>
<span id="cb94-692"><a href="functions.html#cb94-692" aria-hidden="true" tabindex="-1"></a>    grobs[[i]] <span class="ot">&lt;-</span> <span class="fu">ggplotGrob</span>(plots[[i]])</span>
<span id="cb94-693"><a href="functions.html#cb94-693" aria-hidden="true" tabindex="-1"></a>    widths[[i]] <span class="ot">&lt;-</span> grobs[[i]]<span class="sc">$</span>widths[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb94-694"><a href="functions.html#cb94-694" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-695"><a href="functions.html#cb94-695" aria-hidden="true" tabindex="-1"></a>  maxwidth <span class="ot">&lt;-</span> <span class="fu">do.call</span>(grid<span class="sc">::</span>unit.pmax, widths)</span>
<span id="cb94-696"><a href="functions.html#cb94-696" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(grobs)){</span>
<span id="cb94-697"><a href="functions.html#cb94-697" aria-hidden="true" tabindex="-1"></a>    grobs[[i]]<span class="sc">$</span>widths[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="fu">as.list</span>(maxwidth)</span>
<span id="cb94-698"><a href="functions.html#cb94-698" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-699"><a href="functions.html#cb94-699" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-700"><a href="functions.html#cb94-700" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate plot</span></span>
<span id="cb94-701"><a href="functions.html#cb94-701" aria-hidden="true" tabindex="-1"></a>  grob.title <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(<span class="fu">paste</span>(sample,<span class="st">&quot;-&quot;</span>,name_var), <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">20</span>))</span>
<span id="cb94-702"><a href="functions.html#cb94-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pdf</span>(<span class="fu">paste</span>(output_folder,<span class="st">&quot;Graphs_significant/&quot;</span>,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>), <span class="at">width =</span> <span class="dv">16</span>, <span class="at">height =</span> <span class="dv">8</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb94-703"><a href="functions.html#cb94-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grid.arrange</span>(<span class="at">grobs=</span>grobs, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">top =</span> grob.title)</span>
<span id="cb94-704"><a href="functions.html#cb94-704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">graphics.off</span>()</span>
<span id="cb94-705"><a href="functions.html#cb94-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-706"><a href="functions.html#cb94-706" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-707"><a href="functions.html#cb94-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-708"><a href="functions.html#cb94-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-709"><a href="functions.html#cb94-709" aria-hidden="true" tabindex="-1"></a>plot_clonal_heatmap_and_barplot <span class="ot">&lt;-</span><span class="cf">function</span>(sample,output_folder,clonal_abundance,clonal_architecture,clone_cell_count,shrink)</span>
<span id="cb94-710"><a href="functions.html#cb94-710" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb94-711"><a href="functions.html#cb94-711" aria-hidden="true" tabindex="-1"></a>  <span class="co">#clonal_abundance_subset &lt;-data.frame( clonal_abundance[[sample]])%&gt;%filter(Count&gt;=5)</span></span>
<span id="cb94-712"><a href="functions.html#cb94-712" aria-hidden="true" tabindex="-1"></a>  <span class="co">#clonal_architecture_subset &lt;- data.frame(clonal_architecture[[sample]])%&gt;%</span></span>
<span id="cb94-713"><a href="functions.html#cb94-713" aria-hidden="true" tabindex="-1"></a>   <span class="co">#                                         filter(Clone%in%as.character(clonal_abundance_subset$Clone))</span></span>
<span id="cb94-714"><a href="functions.html#cb94-714" aria-hidden="true" tabindex="-1"></a>  clonal_abundance_subset<span class="ot">&lt;-</span>final_sample_summary[[sample]]<span class="sc">$</span>Clones<span class="co">#clonal_abundance</span></span>
<span id="cb94-715"><a href="functions.html#cb94-715" aria-hidden="true" tabindex="-1"></a>  clonal_abundance_subset<span class="sc">$</span>Clone<span class="ot">&lt;-</span><span class="fu">factor</span>(final_sample_summary[[sample]]<span class="sc">$</span>Clones[,<span class="st">&quot;Clone&quot;</span>],<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">c</span>(final_sample_summary[[sample]]<span class="sc">$</span>Clones[,<span class="st">&quot;Clone&quot;</span>])))<span class="co">#clonal_abundance</span></span>
<span id="cb94-716"><a href="functions.html#cb94-716" aria-hidden="true" tabindex="-1"></a>  clonal_architecture_subset<span class="ot">&lt;-</span>final_sample_summary[[sample]]<span class="sc">$</span>Architecture<span class="sc">%&gt;%</span></span>
<span id="cb94-717"><a href="functions.html#cb94-717" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">filter</span>(Clone<span class="sc">%in%</span><span class="fu">as.character</span>(clonal_abundance_subset<span class="sc">$</span>Clone))</span>
<span id="cb94-718"><a href="functions.html#cb94-718" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-719"><a href="functions.html#cb94-719" aria-hidden="true" tabindex="-1"></a>  clonal_architecture_subset<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_architecture_subset<span class="sc">$</span>Clone, <span class="at">levels=</span><span class="fu">levels</span>(clonal_abundance_subset<span class="sc">$</span>Clone))</span>
<span id="cb94-720"><a href="functions.html#cb94-720" aria-hidden="true" tabindex="-1"></a>  gg_heatmap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> clonal_architecture_subset, <span class="fu">aes</span>(<span class="at">x =</span> Clone, <span class="at">y =</span> <span class="fu">factor</span>(Mutant,<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">levels</span>(<span class="fu">factor</span>(Mutant)))), <span class="at">fill =</span> Genotype)) <span class="sc">+</span> </span>
<span id="cb94-721"><a href="functions.html#cb94-721" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span><span class="co"># scale_y_discrete(limits = rev(levels(Mutant)))+</span></span>
<span id="cb94-722"><a href="functions.html#cb94-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-723"><a href="functions.html#cb94-723" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb94-724"><a href="functions.html#cb94-724" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Heterozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb94-725"><a href="functions.html#cb94-725" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Homozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb94-726"><a href="functions.html#cb94-726" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Unknown&quot;</span><span class="ot">=</span><span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="sc">+</span></span>
<span id="cb94-727"><a href="functions.html#cb94-727" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb94-728"><a href="functions.html#cb94-728" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-729"><a href="functions.html#cb94-729" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="at">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb94-730"><a href="functions.html#cb94-730" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb94-731"><a href="functions.html#cb94-731" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-732"><a href="functions.html#cb94-732" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-733"><a href="functions.html#cb94-733" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb94-734"><a href="functions.html#cb94-734" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-735"><a href="functions.html#cb94-735" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-736"><a href="functions.html#cb94-736" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb94-737"><a href="functions.html#cb94-737" aria-hidden="true" tabindex="-1"></a>  gg_clonal_barplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(clonal_abundance_subset), <span class="fu">aes</span>(<span class="at">x =</span> Clone, <span class="at">y =</span> Count)) <span class="sc">+</span> </span>
<span id="cb94-738"><a href="functions.html#cb94-738" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="fu">aes</span>(<span class="at">fill =</span> Count)) <span class="sc">+</span> <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb94-739"><a href="functions.html#cb94-739" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">6</span>)<span class="sc">+</span></span>
<span id="cb94-740"><a href="functions.html#cb94-740" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fu">max</span>(clonal_abundance_subset<span class="sc">$</span>Count)<span class="sc">*</span><span class="fl">1.3</span>) <span class="sc">+</span> </span>
<span id="cb94-741"><a href="functions.html#cb94-741" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-742"><a href="functions.html#cb94-742" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>Count), <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.9</span>), <span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.25</span>,<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb94-743"><a href="functions.html#cb94-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_distiller</span>(<span class="at">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;Reds&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb94-744"><a href="functions.html#cb94-744" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),  <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-745"><a href="functions.html#cb94-745" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb94-746"><a href="functions.html#cb94-746" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="sc">-</span><span class="fl">0.2</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-747"><a href="functions.html#cb94-747" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-748"><a href="functions.html#cb94-748" aria-hidden="true" tabindex="-1"></a>  grob.title <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(<span class="fu">paste</span>(sample,<span class="st">&quot;-&quot;</span>), <span class="at">hjust=</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">12</span>))</span>
<span id="cb94-749"><a href="functions.html#cb94-749" aria-hidden="true" tabindex="-1"></a>  final_plot<span class="ot">&lt;-</span><span class="fu">plot_grid</span>(grob.title,gg_clonal_barplot,gg_heatmap,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">align=</span><span class="st">&quot;hv&quot;</span>,<span class="at">axis=</span><span class="st">&quot;l&quot;</span>,<span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="fl">0.75</span>))</span>
<span id="cb94-750"><a href="functions.html#cb94-750" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb94-751"><a href="functions.html#cb94-751" aria-hidden="true" tabindex="-1"></a>   <span class="fu">save_plot</span>(<span class="fu">paste</span>(output_folder,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>),final_plot, <span class="at">ncol=</span><span class="dv">1</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb94-752"><a href="functions.html#cb94-752" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-753"><a href="functions.html#cb94-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-754"><a href="functions.html#cb94-754" aria-hidden="true" tabindex="-1"></a>generate_and_plot_cooccurence <span class="ot">&lt;-</span> <span class="cf">function</span>(mut_mat){</span>
<span id="cb94-755"><a href="functions.html#cb94-755" aria-hidden="true" tabindex="-1"></a>  cooccur_mat <span class="ot">&lt;-</span> <span class="fu">cooccur</span>(<span class="at">mat=</span><span class="fu">t</span>(mut_mat),<span class="at">type=</span><span class="st">&quot;spp_site&quot;</span>,<span class="at">only_effects =</span> <span class="cn">FALSE</span>,<span class="at">eff_matrix=</span><span class="cn">TRUE</span>,<span class="at">thresh=</span><span class="cn">FALSE</span>,<span class="at">eff_standard=</span><span class="cn">FALSE</span>,<span class="at">spp_names=</span><span class="cn">TRUE</span>)<span class="sc">$</span>results</span>
<span id="cb94-756"><a href="functions.html#cb94-756" aria-hidden="true" tabindex="-1"></a>  cooccur_mat<span class="sc">$</span>score<span class="ot">&lt;-</span>  <span class="fu">ifelse</span>(cooccur_mat[,<span class="st">&quot;p_lt&quot;</span>]<span class="sc">&lt;=</span><span class="fl">0.05</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="fu">ifelse</span>(cooccur_mat[,<span class="st">&quot;p_gt&quot;</span>]<span class="sc">&lt;=</span><span class="fl">0.05</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb94-757"><a href="functions.html#cb94-757" aria-hidden="true" tabindex="-1"></a>  cooccur_mat_subset <span class="ot">&lt;-</span> <span class="fu">rbind</span>(cooccur_mat[,<span class="fu">c</span>(<span class="st">&quot;sp1_name&quot;</span>,<span class="st">&quot;sp2_name&quot;</span>,<span class="st">&quot;score&quot;</span>)],<span class="fu">c</span>(<span class="fu">setdiff</span>(cooccur_mat<span class="sc">$</span>sp2_name,cooccur_mat<span class="sc">$</span>sp1_name),<span class="fu">setdiff</span>(cooccur_mat<span class="sc">$</span>sp1_name,cooccur_mat<span class="sc">$</span>sp2_name),<span class="dv">0</span>))</span>
<span id="cb94-758"><a href="functions.html#cb94-758" aria-hidden="true" tabindex="-1"></a>  cooccur_data_mat <span class="ot">&lt;-</span> <span class="fu">dcast</span>(cooccur_mat_subset, sp1_name  <span class="sc">~</span> sp2_name, <span class="at">value.var=</span><span class="st">&quot;score&quot;</span>)</span>
<span id="cb94-759"><a href="functions.html#cb94-759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(cooccur_data_mat) <span class="ot">&lt;-</span> cooccur_data_mat[,<span class="dv">1</span>]</span>
<span id="cb94-760"><a href="functions.html#cb94-760" aria-hidden="true" tabindex="-1"></a>  cooccur_data_mat2<span class="ot">&lt;-</span>cooccur_data_mat[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb94-761"><a href="functions.html#cb94-761" aria-hidden="true" tabindex="-1"></a>  cooccur_data_mat2[<span class="fu">is.na</span>(cooccur_data_mat2)]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-762"><a href="functions.html#cb94-762" aria-hidden="true" tabindex="-1"></a>  cooccur_data_mat2[<span class="fu">lower.tri</span>(cooccur_data_mat2)]<span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb94-763"><a href="functions.html#cb94-763" aria-hidden="true" tabindex="-1"></a>  cooccur_data_mat2<span class="sc">$</span>Gene <span class="ot">&lt;-</span> <span class="fu">rownames</span>(cooccur_data_mat2)</span>
<span id="cb94-764"><a href="functions.html#cb94-764" aria-hidden="true" tabindex="-1"></a>  cooccur_data_mat_melt <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">melt</span>(cooccur_data_mat2, <span class="st">&#39;Gene&#39;</span>, <span class="at">variable_name=</span><span class="st">&#39;Gene2&#39;</span>))</span>
<span id="cb94-765"><a href="functions.html#cb94-765" aria-hidden="true" tabindex="-1"></a>  cooccur_data_mat_melt<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">factor</span>(cooccur_data_mat_melt<span class="sc">$</span>variable, <span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">levels</span>(cooccur_data_mat_melt<span class="sc">$</span>variable)))</span>
<span id="cb94-766"><a href="functions.html#cb94-766" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-767"><a href="functions.html#cb94-767" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-768"><a href="functions.html#cb94-768" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Triangle heatmap to compare cohorts</span></span>
<span id="cb94-769"><a href="functions.html#cb94-769" aria-hidden="true" tabindex="-1"></a>  grob_corrplot<span class="ot">&lt;-</span><span class="fu">ggplot</span>(cooccur_data_mat_melt, <span class="fu">aes</span>(Gene, variable))<span class="sc">+</span></span>
<span id="cb94-770"><a href="functions.html#cb94-770" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">factor</span>(value)), <span class="at">color=</span><span class="st">&#39;grey90&#39;</span>) <span class="sc">+</span></span>
<span id="cb94-771"><a href="functions.html#cb94-771" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;-1&quot;</span><span class="ot">=</span><span class="st">&quot;firebrick3&quot;</span>,<span class="st">&quot;0&quot;</span><span class="ot">=</span><span class="st">&quot;white&quot;</span>,<span class="st">&quot;1&quot;</span><span class="ot">=</span><span class="st">&quot;steelblue2&quot;</span>),<span class="st">&quot;Correlation&quot;</span>,</span>
<span id="cb94-772"><a href="functions.html#cb94-772" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Mutually Exclusive&quot;</span>,<span class="st">&quot;Not Significant&quot;</span>,<span class="st">&quot;Mutually Inclusive&quot;</span>))<span class="sc">+</span></span>
<span id="cb94-773"><a href="functions.html#cb94-773" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">10</span>)<span class="sc">+</span><span class="fu">xlab</span>(<span class="st">&quot;&quot;</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-774"><a href="functions.html#cb94-774" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">45</span>,<span class="at">hjust=</span><span class="dv">1</span>,<span class="at">vjust=</span><span class="dv">1</span>),</span>
<span id="cb94-775"><a href="functions.html#cb94-775" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.line =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb94-776"><a href="functions.html#cb94-776" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>,<span class="dv">1</span>), </span>
<span id="cb94-777"><a href="functions.html#cb94-777" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb94-778"><a href="functions.html#cb94-778" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">&quot;vertical&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-779"><a href="functions.html#cb94-779" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>,<span class="st">&quot;line&quot;</span>))</span>
<span id="cb94-780"><a href="functions.html#cb94-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;plot&quot;</span><span class="ot">=</span>grob_corrplot,</span>
<span id="cb94-781"><a href="functions.html#cb94-781" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;data&quot;</span><span class="ot">=</span>cooccur_mat))</span>
<span id="cb94-782"><a href="functions.html#cb94-782" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-783"><a href="functions.html#cb94-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-784"><a href="functions.html#cb94-784" aria-hidden="true" tabindex="-1"></a>diversity_from_bulk_VAF <span class="ot">&lt;-</span> <span class="cf">function</span>(sample){</span>
<span id="cb94-785"><a href="functions.html#cb94-785" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-786"><a href="functions.html#cb94-786" aria-hidden="true" tabindex="-1"></a>      LAM_VARIANTS_MAT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-787"><a href="functions.html#cb94-787" aria-hidden="true" tabindex="-1"></a>      LAM_VARIANTS_SNP <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb94-788"><a href="functions.html#cb94-788" aria-hidden="true" tabindex="-1"></a>      LAM_VARIANTS_Protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>((LAM_VARIANTS_MAT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Include<span class="sc">==</span><span class="st">&quot;Include&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb94-789"><a href="functions.html#cb94-789" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb94-790"><a href="functions.html#cb94-790" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb94-791"><a href="functions.html#cb94-791" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb94-792"><a href="functions.html#cb94-792" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-793"><a href="functions.html#cb94-793" aria-hidden="true" tabindex="-1"></a>    <span class="co">#AF &lt;- read.csv(paste(&quot;./&quot;,sample,&quot;/&quot;,&quot;AF.csv&quot;,sep=&quot;&quot;))                    # - variant allele frequency</span></span>
<span id="cb94-794"><a href="functions.html#cb94-794" aria-hidden="true" tabindex="-1"></a>    <span class="co">#DP &lt;- read.csv(paste(&quot;./&quot;,sample,&quot;/&quot;,&quot;DP.csv&quot;,sep=&quot;&quot;))                     # - read depth</span></span>
<span id="cb94-795"><a href="functions.html#cb94-795" aria-hidden="true" tabindex="-1"></a>    <span class="co">#GQ &lt;- read.csv(paste(&quot;./&quot;,sample,&quot;/&quot;,&quot;GQ.csv&quot;,sep=&quot;&quot;))                    # - quality scores</span></span>
<span id="cb94-796"><a href="functions.html#cb94-796" aria-hidden="true" tabindex="-1"></a>    NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb94-797"><a href="functions.html#cb94-797" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-798"><a href="functions.html#cb94-798" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="fu">list.files</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb94-799"><a href="functions.html#cb94-799" aria-hidden="true" tabindex="-1"></a>      SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb94-800"><a href="functions.html#cb94-800" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(NGT)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-801"><a href="functions.html#cb94-801" aria-hidden="true" tabindex="-1"></a>      SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-802"><a href="functions.html#cb94-802" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-803"><a href="functions.html#cb94-803" aria-hidden="true" tabindex="-1"></a>               <span class="fu">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-804"><a href="functions.html#cb94-804" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-805"><a href="functions.html#cb94-805" aria-hidden="true" tabindex="-1"></a>      })<span class="co"># - variant metadata</span></span>
<span id="cb94-806"><a href="functions.html#cb94-806" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb94-807"><a href="functions.html#cb94-807" aria-hidden="true" tabindex="-1"></a>      SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb94-808"><a href="functions.html#cb94-808" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(NGT)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-809"><a href="functions.html#cb94-809" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(SNP_INFO)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;protein&quot;</span></span>
<span id="cb94-810"><a href="functions.html#cb94-810" aria-hidden="true" tabindex="-1"></a>      SNP_INFO<span class="sc">$</span>cDNA <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>cDNA)</span>
<span id="cb94-811"><a href="functions.html#cb94-811" aria-hidden="true" tabindex="-1"></a>      SNP_INFO<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>protein)</span>
<span id="cb94-812"><a href="functions.html#cb94-812" aria-hidden="true" tabindex="-1"></a>      SNP_INFO<span class="sc">$</span>Variant <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Variant)</span>
<span id="cb94-813"><a href="functions.html#cb94-813" aria-hidden="true" tabindex="-1"></a>      SNP_INFO<span class="sc">$</span>Gene <span class="ot">&lt;-</span> <span class="fu">as.character</span>(SNP_INFO<span class="sc">$</span>Gene)</span>
<span id="cb94-814"><a href="functions.html#cb94-814" aria-hidden="true" tabindex="-1"></a>      SNP_INFO[,<span class="fu">c</span>(<span class="st">&quot;protein&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-815"><a href="functions.html#cb94-815" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb94-816"><a href="functions.html#cb94-816" aria-hidden="true" tabindex="-1"></a>               <span class="fu">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="sc">!=</span><span class="st">&quot;&quot;</span>,<span class="fu">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb94-817"><a href="functions.html#cb94-817" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="fu">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="at">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb94-818"><a href="functions.html#cb94-818" aria-hidden="true" tabindex="-1"></a>      })<span class="co"># - variant metadata</span></span>
<span id="cb94-819"><a href="functions.html#cb94-819" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-820"><a href="functions.html#cb94-820" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-821"><a href="functions.html#cb94-821" aria-hidden="true" tabindex="-1"></a>    SNP_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_SNP</span>
<span id="cb94-822"><a href="functions.html#cb94-822" aria-hidden="true" tabindex="-1"></a>    protein_changes_of_interest <span class="ot">&lt;-</span> LAM_VARIANTS_Protein</span>
<span id="cb94-823"><a href="functions.html#cb94-823" aria-hidden="true" tabindex="-1"></a>    SNP_protein_key <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Mutant&quot;</span><span class="ot">=</span>SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span><span class="ot">=</span>protein_changes_of_interest)</span>
<span id="cb94-824"><a href="functions.html#cb94-824" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-825"><a href="functions.html#cb94-825" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cell and clone selection</span></span>
<span id="cb94-826"><a href="functions.html#cb94-826" aria-hidden="true" tabindex="-1"></a>    distribution_of_unknowns_by_variant <span class="ot">&lt;-</span> <span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb94-827"><a href="functions.html#cb94-827" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb94-828"><a href="functions.html#cb94-828" aria-hidden="true" tabindex="-1"></a>    cells_with_unknown<span class="ot">&lt;-</span>NGT[<span class="fu">apply</span>(NGT[,SNP_changes_of_interest],<span class="at">MARGIN=</span><span class="dv">1</span>,<span class="at">FUN=</span><span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">==</span><span class="dv">3</span>)<span class="sc">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb94-829"><a href="functions.html#cb94-829" aria-hidden="true" tabindex="-1"></a>    matrix_of_interest<span class="ot">&lt;-</span>NGT[<span class="sc">!</span>NGT<span class="sc">$</span>Cell<span class="sc">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb94-830"><a href="functions.html#cb94-830" aria-hidden="true" tabindex="-1"></a>    bulk_VAF_order<span class="ot">&lt;-</span>SNP_INFO[<span class="fu">colnames</span>(matrix_of_interest)[<span class="fu">order</span>(<span class="fu">colSums</span>(matrix_of_interest),<span class="at">decreasing=</span><span class="cn">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb94-831"><a href="functions.html#cb94-831" aria-hidden="true" tabindex="-1"></a>    bulk_VAF_order <span class="ot">&lt;-</span> bulk_VAF_order[<span class="sc">!</span><span class="fu">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb94-832"><a href="functions.html#cb94-832" aria-hidden="true" tabindex="-1"></a>    matrix_of_interest<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-833"><a href="functions.html#cb94-833" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-834"><a href="functions.html#cb94-834" aria-hidden="true" tabindex="-1"></a>    output<span class="ot">&lt;-</span><span class="fu">diversity</span>(<span class="fu">colSums</span>(matrix_of_interest[<span class="fu">colnames</span>(matrix_of_interest)<span class="sc">!=</span><span class="st">&quot;Clone&quot;</span>])<span class="sc">/</span><span class="fu">length</span>(<span class="fu">rownames</span>(matrix_of_interest)))</span>
<span id="cb94-835"><a href="functions.html#cb94-835" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.table</span>(output,<span class="fu">paste0</span>(output_folder,<span class="st">&quot;Diversity_score_faux_VAF/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb94-836"><a href="functions.html#cb94-836" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-837"><a href="functions.html#cb94-837" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-838"><a href="functions.html#cb94-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-839"><a href="functions.html#cb94-839" aria-hidden="true" tabindex="-1"></a><span class="do">## Old Functions</span></span>
<span id="cb94-840"><a href="functions.html#cb94-840" aria-hidden="true" tabindex="-1"></a>plot_variants_AF_and_DP <span class="ot">&lt;-</span> <span class="cf">function</span>(sample){</span>
<span id="cb94-841"><a href="functions.html#cb94-841" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-842"><a href="functions.html#cb94-842" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Load in the data</span></span>
<span id="cb94-843"><a href="functions.html#cb94-843" aria-hidden="true" tabindex="-1"></a>  AF <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb94-844"><a href="functions.html#cb94-844" aria-hidden="true" tabindex="-1"></a>  DP <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb94-845"><a href="functions.html#cb94-845" aria-hidden="true" tabindex="-1"></a>  GQ <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb94-846"><a href="functions.html#cb94-846" aria-hidden="true" tabindex="-1"></a>  NGT <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))                 <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb94-847"><a href="functions.html#cb94-847" aria-hidden="true" tabindex="-1"></a>  SNP_INFO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))         <span class="co"># - variant metadata</span></span>
<span id="cb94-848"><a href="functions.html#cb94-848" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(SNP_INFO) <span class="ot">&lt;-</span><span class="fu">colnames</span>(AF)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb94-849"><a href="functions.html#cb94-849" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-850"><a href="functions.html#cb94-850" aria-hidden="true" tabindex="-1"></a>  AF_NGT_Melt<span class="ot">&lt;-</span><span class="fu">inner_join</span>(AF <span class="sc">%&gt;%</span> <span class="fu">unite</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>)) <span class="sc">%&gt;%</span><span class="fu">melt</span>(<span class="st">&quot;Sample_cell&quot;</span>),</span>
<span id="cb94-851"><a href="functions.html#cb94-851" aria-hidden="true" tabindex="-1"></a>                          NGT <span class="sc">%&gt;%</span> <span class="fu">unite</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>)) <span class="sc">%&gt;%</span><span class="fu">melt</span>(<span class="st">&quot;Sample_cell&quot;</span>),</span>
<span id="cb94-852"><a href="functions.html#cb94-852" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="st">&quot;variable&quot;</span>))</span>
<span id="cb94-853"><a href="functions.html#cb94-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(AF_NGT_Melt) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;Variant&quot;</span>,<span class="st">&quot;AF&quot;</span>,<span class="st">&quot;NGT&quot;</span>)</span>
<span id="cb94-854"><a href="functions.html#cb94-854" aria-hidden="true" tabindex="-1"></a>  gg_AF_NGT<span class="ot">&lt;-</span>  <span class="fu">ggplot</span>(AF_NGT_Melt,<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.factor</span>(NGT),<span class="at">y=</span>AF,<span class="at">color=</span>NGT))<span class="sc">+</span> <span class="fu">geom_quasirandom</span>()<span class="sc">+</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>Variant,<span class="at">ncol=</span><span class="dv">3</span>)</span>
<span id="cb94-855"><a href="functions.html#cb94-855" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-856"><a href="functions.html#cb94-856" aria-hidden="true" tabindex="-1"></a>  DP_NGT_Melt<span class="ot">&lt;-</span><span class="fu">inner_join</span>(DP <span class="sc">%&gt;%</span> <span class="fu">unite</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>)) <span class="sc">%&gt;%</span><span class="fu">melt</span>(<span class="st">&quot;Sample_cell&quot;</span>),</span>
<span id="cb94-857"><a href="functions.html#cb94-857" aria-hidden="true" tabindex="-1"></a>                          NGT <span class="sc">%&gt;%</span> <span class="fu">unite</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>)) <span class="sc">%&gt;%</span><span class="fu">melt</span>(<span class="st">&quot;Sample_cell&quot;</span>),</span>
<span id="cb94-858"><a href="functions.html#cb94-858" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="st">&quot;variable&quot;</span>))</span>
<span id="cb94-859"><a href="functions.html#cb94-859" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(DP_NGT_Melt) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;Variant&quot;</span>,<span class="st">&quot;DP&quot;</span>,<span class="st">&quot;NGT&quot;</span>)</span>
<span id="cb94-860"><a href="functions.html#cb94-860" aria-hidden="true" tabindex="-1"></a>  gg_DP_NGT<span class="ot">&lt;-</span> <span class="fu">ggplot</span>(DP_NGT_Melt,<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.factor</span>(NGT),<span class="at">y=</span>DP,<span class="at">fill=</span>NGT))<span class="sc">+</span><span class="fu">geom_boxplot</span>()<span class="sc">+</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>Variant,<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">scale=</span><span class="st">&quot;free_y&quot;</span>)</span>
<span id="cb94-861"><a href="functions.html#cb94-861" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-862"><a href="functions.html#cb94-862" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-863"><a href="functions.html#cb94-863" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_DP_NGT.pdf&quot;</span>),gg_DP_NGT,<span class="at">width=</span><span class="dv">10</span>,<span class="at">height=</span><span class="dv">40</span>)</span>
<span id="cb94-864"><a href="functions.html#cb94-864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_AF_NGT.pdf&quot;</span>),gg_AF_NGT,<span class="at">width=</span><span class="dv">10</span>,<span class="at">height=</span><span class="dv">40</span>)</span>
<span id="cb94-865"><a href="functions.html#cb94-865" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-866"><a href="functions.html#cb94-866" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-867"><a href="functions.html#cb94-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-868"><a href="functions.html#cb94-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-869"><a href="functions.html#cb94-869" aria-hidden="true" tabindex="-1"></a>plot_COMPASS_data <span class="ot">&lt;-</span><span class="cf">function</span>(sample,output_folder,melted_protein_mat,clonal_abundance,clonal_architecture,clone_cell_count,shrink)</span>
<span id="cb94-870"><a href="functions.html#cb94-870" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb94-871"><a href="functions.html#cb94-871" aria-hidden="true" tabindex="-1"></a>  melted_protein_mat <span class="ot">&lt;-</span>melted_protein_mat[[sample]]</span>
<span id="cb94-872"><a href="functions.html#cb94-872" aria-hidden="true" tabindex="-1"></a>    clonal_abundance_subset <span class="ot">&lt;-</span><span class="fu">data.frame</span>( clonal_abundance[[sample]])<span class="co">#%&gt;%filter(Count&gt;=5)</span></span>
<span id="cb94-873"><a href="functions.html#cb94-873" aria-hidden="true" tabindex="-1"></a>    clonal_architecture_subset <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(clonal_architecture[[sample]])<span class="co">#%&gt;%</span></span>
<span id="cb94-874"><a href="functions.html#cb94-874" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  filter(Clone%in%as.character(clonal_abundance_subset$Clone))</span></span>
<span id="cb94-875"><a href="functions.html#cb94-875" aria-hidden="true" tabindex="-1"></a>    genes_to_display <span class="ot">&lt;-</span><span class="fu">unique</span>(<span class="fu">as.character</span>(clonal_architecture_subset[clonal_architecture_subset<span class="sc">$</span>Genotype<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>),<span class="st">&quot;Mutant&quot;</span>]))</span>
<span id="cb94-876"><a href="functions.html#cb94-876" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-877"><a href="functions.html#cb94-877" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(shrink<span class="sc">==</span><span class="cn">TRUE</span>){</span>
<span id="cb94-878"><a href="functions.html#cb94-878" aria-hidden="true" tabindex="-1"></a>      clonal_architecture_subset <span class="ot">&lt;-</span>clonal_architecture_subset<span class="sc">%&gt;%</span><span class="fu">filter</span>(Mutant<span class="sc">%in%</span>genes_to_display)</span>
<span id="cb94-879"><a href="functions.html#cb94-879" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-880"><a href="functions.html#cb94-880" aria-hidden="true" tabindex="-1"></a>    clonal_architecture_subset<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_architecture_subset<span class="sc">$</span>Clone, <span class="at">levels=</span><span class="fu">levels</span>(clonal_abundance_subset<span class="sc">$</span>Clone))</span>
<span id="cb94-881"><a href="functions.html#cb94-881" aria-hidden="true" tabindex="-1"></a>    melted_protein_mat_subset<span class="ot">&lt;-</span>melted_protein_mat<span class="sc">%&gt;%</span><span class="fu">filter</span>(Clone<span class="sc">%in%</span><span class="fu">as.character</span>(clonal_architecture_subset<span class="sc">$</span>Clone))</span>
<span id="cb94-882"><a href="functions.html#cb94-882" aria-hidden="true" tabindex="-1"></a>    melted_protein_mat_subset<span class="sc">$</span>Clone <span class="ot">&lt;-</span><span class="fu">factor</span>(melted_protein_mat_subset<span class="sc">$</span>Clone, <span class="at">levels=</span><span class="fu">levels</span>(clonal_abundance_subset<span class="sc">$</span>Clone))</span>
<span id="cb94-883"><a href="functions.html#cb94-883" aria-hidden="true" tabindex="-1"></a>    gg_protein_heatmap<span class="ot">&lt;-</span><span class="fu">ggplot</span>(melted_protein_mat_subset, <span class="fu">aes</span>(<span class="at">y=</span>variable, <span class="at">x=</span>(Clone))) <span class="sc">+</span> <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> value),<span class="at">colour =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span> </span>
<span id="cb94-884"><a href="functions.html#cb94-884" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;PRGn&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-885"><a href="functions.html#cb94-885" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>(<span class="at">base_size=</span><span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb94-886"><a href="functions.html#cb94-886" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>( <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb94-887"><a href="functions.html#cb94-887" aria-hidden="true" tabindex="-1"></a>             <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>,<span class="at">legend.direction =</span> <span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb94-888"><a href="functions.html#cb94-888" aria-hidden="true" tabindex="-1"></a>             <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb94-889"><a href="functions.html#cb94-889" aria-hidden="true" tabindex="-1"></a>             <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-890"><a href="functions.html#cb94-890" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-891"><a href="functions.html#cb94-891" aria-hidden="true" tabindex="-1"></a>     gg_heatmap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> clonal_architecture_subset, <span class="fu">aes</span>(<span class="at">x =</span> Clone, <span class="at">y =</span> <span class="fu">factor</span>(Mutant,<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">levels</span>(<span class="fu">factor</span>(Mutant)))), <span class="at">fill =</span> Genotype)) <span class="sc">+</span> </span>
<span id="cb94-892"><a href="functions.html#cb94-892" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_tile</span>() <span class="sc">+</span><span class="co"># scale_y_discrete(limits = rev(levels(Mutant)))+</span></span>
<span id="cb94-893"><a href="functions.html#cb94-893" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb94-894"><a href="functions.html#cb94-894" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;Heterozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb94-895"><a href="functions.html#cb94-895" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;Homozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb94-896"><a href="functions.html#cb94-896" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;Unknown&quot;</span><span class="ot">=</span><span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="sc">+</span></span>
<span id="cb94-897"><a href="functions.html#cb94-897" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb94-898"><a href="functions.html#cb94-898" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-899"><a href="functions.html#cb94-899" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>, <span class="at">legend.direction =</span> <span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb94-900"><a href="functions.html#cb94-900" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb94-901"><a href="functions.html#cb94-901" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-902"><a href="functions.html#cb94-902" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-903"><a href="functions.html#cb94-903" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb94-904"><a href="functions.html#cb94-904" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-905"><a href="functions.html#cb94-905" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-906"><a href="functions.html#cb94-906" aria-hidden="true" tabindex="-1"></a>    clone_colors <span class="ot">&lt;-</span> <span class="fu">alphabet</span>()[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(clonal_abundance_subset<span class="sc">$</span>Clone))]</span>
<span id="cb94-907"><a href="functions.html#cb94-907" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(clone_colors) <span class="ot">&lt;-</span><span class="fu">levels</span>(clonal_abundance_subset<span class="sc">$</span>Clone)</span>
<span id="cb94-908"><a href="functions.html#cb94-908" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb94-909"><a href="functions.html#cb94-909" aria-hidden="true" tabindex="-1"></a>    gg_clonal_barplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(clonal_abundance_subset), <span class="fu">aes</span>(<span class="at">x =</span> Clone, <span class="at">y =</span> Count)) <span class="sc">+</span> </span>
<span id="cb94-910"><a href="functions.html#cb94-910" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="fu">aes</span>(<span class="at">fill =</span> Clone)) <span class="sc">+</span> <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb94-911"><a href="functions.html#cb94-911" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">6</span>)<span class="sc">+</span></span>
<span id="cb94-912"><a href="functions.html#cb94-912" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fu">max</span>(clonal_abundance_subset<span class="sc">$</span>Count)<span class="sc">*</span><span class="fl">1.3</span>) <span class="sc">+</span> </span>
<span id="cb94-913"><a href="functions.html#cb94-913" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-914"><a href="functions.html#cb94-914" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>Count), <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.9</span>), <span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.25</span>,<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb94-915"><a href="functions.html#cb94-915" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_manual</span>(<span class="at">values=</span>clone_colors)<span class="sc">+</span></span>
<span id="cb94-916"><a href="functions.html#cb94-916" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),  <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-917"><a href="functions.html#cb94-917" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb94-918"><a href="functions.html#cb94-918" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-919"><a href="functions.html#cb94-919" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-920"><a href="functions.html#cb94-920" aria-hidden="true" tabindex="-1"></a>    grob.title <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(<span class="fu">paste</span>(sample,<span class="st">&quot;-&quot;</span>), <span class="at">hjust=</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">12</span>))</span>
<span id="cb94-921"><a href="functions.html#cb94-921" aria-hidden="true" tabindex="-1"></a>    final_plot<span class="ot">&lt;-</span><span class="fu">plot_grid</span>(gg_clonal_barplot,<span class="fu">addSmallLegend</span>(gg_heatmap),<span class="fu">addSmallLegend</span>(gg_protein_heatmap),<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">align=</span><span class="st">&quot;hv&quot;</span>,<span class="at">axis=</span><span class="st">&quot;lrtb&quot;</span>,<span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,(<span class="fu">length</span>(genes_to_display)<span class="sc">*</span><span class="fl">0.15</span>),<span class="dv">1</span>))</span>
<span id="cb94-922"><a href="functions.html#cb94-922" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-923"><a href="functions.html#cb94-923" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save_plot</span>(<span class="fu">paste</span>(output_folder,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>),final_plot, <span class="at">ncol=</span><span class="dv">1</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb94-924"><a href="functions.html#cb94-924" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-925"><a href="functions.html#cb94-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-926"><a href="functions.html#cb94-926" aria-hidden="true" tabindex="-1"></a>addSmallLegend <span class="ot">&lt;-</span> <span class="cf">function</span>(myPlot, <span class="at">pointSize =</span> <span class="dv">3</span>, <span class="at">textSize =</span> <span class="dv">8</span>, <span class="at">spaceLegend =</span> <span class="fl">0.5</span>) {</span>
<span id="cb94-927"><a href="functions.html#cb94-927" aria-hidden="true" tabindex="-1"></a>  myPlot <span class="sc">+</span></span>
<span id="cb94-928"><a href="functions.html#cb94-928" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> pointSize)),</span>
<span id="cb94-929"><a href="functions.html#cb94-929" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> pointSize))) <span class="sc">+</span></span>
<span id="cb94-930"><a href="functions.html#cb94-930" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> textSize), </span>
<span id="cb94-931"><a href="functions.html#cb94-931" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text  =</span> <span class="fu">element_text</span>(<span class="at">size =</span> textSize),</span>
<span id="cb94-932"><a href="functions.html#cb94-932" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.size =</span> <span class="fu">unit</span>(spaceLegend, <span class="st">&quot;lines&quot;</span>))</span>
<span id="cb94-933"><a href="functions.html#cb94-933" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-934"><a href="functions.html#cb94-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-935"><a href="functions.html#cb94-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-936"><a href="functions.html#cb94-936" aria-hidden="true" tabindex="-1"></a>create_reward_matrix_deprecated<span class="ot">&lt;-</span><span class="cf">function</span>(Known_mat,weights){</span>
<span id="cb94-937"><a href="functions.html#cb94-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">68864</span>)</span>
<span id="cb94-938"><a href="functions.html#cb94-938" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(weights) <span class="ot">&lt;-</span> <span class="fu">apply</span>(Known_mat,<span class="dv">2</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-939"><a href="functions.html#cb94-939" aria-hidden="true" tabindex="-1"></a>  num_type <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb94-940"><a href="functions.html#cb94-940" aria-hidden="true" tabindex="-1"></a>  num_mutations <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Known_mat); </span>
<span id="cb94-941"><a href="functions.html#cb94-941" aria-hidden="true" tabindex="-1"></a>  num_clones <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Known_mat)</span>
<span id="cb94-942"><a href="functions.html#cb94-942" aria-hidden="true" tabindex="-1"></a>  num_states <span class="ot">&lt;-</span> num_type<span class="sc">^</span>num_mutations</span>
<span id="cb94-943"><a href="functions.html#cb94-943" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-944"><a href="functions.html#cb94-944" aria-hidden="true" tabindex="-1"></a>  states<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">expand.grid</span>(<span class="fu">rep</span>(<span class="fu">list</span>(<span class="dv">0</span><span class="sc">:</span>num_type), num_mutations)))</span>
<span id="cb94-945"><a href="functions.html#cb94-945" aria-hidden="true" tabindex="-1"></a>  state_interactions<span class="ot">&lt;-</span><span class="fu">expand.grid</span>(<span class="fu">apply</span>(states[,<span class="dv">1</span><span class="sc">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>)}),</span>
<span id="cb94-946"><a href="functions.html#cb94-946" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">apply</span>(states[,<span class="dv">1</span><span class="sc">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>)}))</span>
<span id="cb94-947"><a href="functions.html#cb94-947" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-948"><a href="functions.html#cb94-948" aria-hidden="true" tabindex="-1"></a>  states<span class="sc">$</span>Reward_states<span class="ot">&lt;-</span><span class="fu">ifelse</span>(<span class="fu">apply</span>(states,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-949"><a href="functions.html#cb94-949" aria-hidden="true" tabindex="-1"></a>    <span class="fu">any</span>(<span class="fu">apply</span>(Known_mat,<span class="dv">2</span>,<span class="cf">function</span>(y){ <span class="fu">all</span>(x<span class="sc">==</span><span class="fu">t</span>(y))}))</span>
<span id="cb94-950"><a href="functions.html#cb94-950" aria-hidden="true" tabindex="-1"></a>  }),<span class="dv">2</span>,<span class="cn">NA</span>)</span>
<span id="cb94-951"><a href="functions.html#cb94-951" aria-hidden="true" tabindex="-1"></a>  states<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">apply</span>(states[,<span class="dv">1</span><span class="sc">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-952"><a href="functions.html#cb94-952" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-953"><a href="functions.html#cb94-953" aria-hidden="true" tabindex="-1"></a>  state_interactions<span class="sc">$</span>possible<span class="ot">&lt;-</span><span class="fu">ifelse</span>(<span class="fu">apply</span>(state_interactions,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-954"><a href="functions.html#cb94-954" aria-hidden="true" tabindex="-1"></a>    A<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">do.call</span>(cbind,<span class="fu">strsplit</span>(<span class="fu">as.character</span>(x[<span class="dv">1</span>]),<span class="at">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb94-955"><a href="functions.html#cb94-955" aria-hidden="true" tabindex="-1"></a>    B<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">do.call</span>(cbind,<span class="fu">strsplit</span>(<span class="fu">as.character</span>(x[<span class="dv">2</span>]),<span class="at">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb94-956"><a href="functions.html#cb94-956" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">abs</span>(A<span class="sc">-</span>B))<span class="sc">&lt;=</span><span class="dv">1</span></span>
<span id="cb94-957"><a href="functions.html#cb94-957" aria-hidden="true" tabindex="-1"></a>  }),<span class="dv">2</span>,<span class="cn">NA</span>)</span>
<span id="cb94-958"><a href="functions.html#cb94-958" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-959"><a href="functions.html#cb94-959" aria-hidden="true" tabindex="-1"></a>  dat<span class="ot">&lt;-</span><span class="fu">acast</span>(Var1<span class="sc">~</span>Var2,<span class="at">value.var=</span><span class="st">&quot;possible&quot;</span>,<span class="at">data=</span><span class="fu">data.frame</span>(state_interactions,</span>
<span id="cb94-960"><a href="functions.html#cb94-960" aria-hidden="true" tabindex="-1"></a>                                                            <span class="st">&quot;value&quot;</span><span class="ot">=</span><span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb94-961"><a href="functions.html#cb94-961" aria-hidden="true" tabindex="-1"></a>  <span class="fu">diag</span>(dat)<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-962"><a href="functions.html#cb94-962" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lowerTriangle</span>(dat)<span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb94-963"><a href="functions.html#cb94-963" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-964"><a href="functions.html#cb94-964" aria-hidden="true" tabindex="-1"></a>  test_dat<span class="ot">&lt;-</span><span class="fu">do.call</span>(cbind,<span class="fu">lapply</span>(<span class="fu">colnames</span>(dat),<span class="cf">function</span>(Clone){</span>
<span id="cb94-965"><a href="functions.html#cb94-965" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(Clone<span class="sc">%in%</span><span class="fu">names</span>(weights)){</span>
<span id="cb94-966"><a href="functions.html#cb94-966" aria-hidden="true" tabindex="-1"></a>      output<span class="ot">&lt;-</span><span class="fu">ifelse</span>(dat[,Clone]<span class="sc">==</span><span class="dv">2</span>,weights[Clone],dat[,Clone])</span>
<span id="cb94-967"><a href="functions.html#cb94-967" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb94-968"><a href="functions.html#cb94-968" aria-hidden="true" tabindex="-1"></a>      output<span class="ot">&lt;-</span>dat[,Clone]</span>
<span id="cb94-969"><a href="functions.html#cb94-969" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-970"><a href="functions.html#cb94-970" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(output)</span>
<span id="cb94-971"><a href="functions.html#cb94-971" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb94-972"><a href="functions.html#cb94-972" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(test_dat) <span class="ot">&lt;-</span><span class="fu">rownames</span>(test_dat)</span>
<span id="cb94-973"><a href="functions.html#cb94-973" aria-hidden="true" tabindex="-1"></a>  graph<span class="ot">&lt;-</span><span class="fu">graph.adjacency</span>(test_dat,<span class="at">mode=</span><span class="st">&quot;directed&quot;</span>,<span class="at">weighted=</span><span class="cn">TRUE</span>)</span>
<span id="cb94-974"><a href="functions.html#cb94-974" aria-hidden="true" tabindex="-1"></a>  graph_mat <span class="ot">&lt;-</span> <span class="fu">get.data.frame</span>(graph)<span class="sc">%&gt;%</span> <span class="fu">drop_na</span>()</span>
<span id="cb94-975"><a href="functions.html#cb94-975" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-976"><a href="functions.html#cb94-976" aria-hidden="true" tabindex="-1"></a>  subgraphs<span class="ot">&lt;-</span><span class="fu">make_ego_graph</span>(<span class="fu">graph_from_data_frame</span>(graph_mat,<span class="at">directed=</span><span class="cn">TRUE</span>), <span class="at">order=</span><span class="dv">1</span>,<span class="at">nodes=</span><span class="fu">names</span>(weights), <span class="at">mode=</span><span class="st">&quot;all&quot;</span>)</span>
<span id="cb94-977"><a href="functions.html#cb94-977" aria-hidden="true" tabindex="-1"></a>  subgraph_bind<span class="ot">&lt;-</span><span class="fu">do.call</span>(rbind,<span class="fu">lapply</span>(subgraphs,get.data.frame)) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(to,from,weight, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb94-978"><a href="functions.html#cb94-978" aria-hidden="true" tabindex="-1"></a>  subgraph_subset<span class="ot">&lt;-</span>subgraph_bind<span class="sc">%&gt;%</span><span class="fu">filter</span>(<span class="sc">!</span>to<span class="sc">%in%</span><span class="fu">setdiff</span>(<span class="fu">setdiff</span>(subgraph_bind<span class="sc">$</span>to,subgraph_bind<span class="sc">$</span>from),<span class="fu">names</span>(weights)))</span>
<span id="cb94-979"><a href="functions.html#cb94-979" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(subgraph_subset)</span>
<span id="cb94-980"><a href="functions.html#cb94-980" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-981"><a href="functions.html#cb94-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-982"><a href="functions.html#cb94-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-983"><a href="functions.html#cb94-983" aria-hidden="true" tabindex="-1"></a>create_reward_matrix<span class="ot">&lt;-</span><span class="cf">function</span>(Known_mat,weights){</span>
<span id="cb94-984"><a href="functions.html#cb94-984" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-985"><a href="functions.html#cb94-985" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">68864</span>)</span>
<span id="cb94-986"><a href="functions.html#cb94-986" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(weights) <span class="ot">&lt;-</span> <span class="fu">apply</span>(Known_mat,<span class="dv">2</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb94-987"><a href="functions.html#cb94-987" aria-hidden="true" tabindex="-1"></a>  num_type <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb94-988"><a href="functions.html#cb94-988" aria-hidden="true" tabindex="-1"></a>  num_mutations <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Known_mat); </span>
<span id="cb94-989"><a href="functions.html#cb94-989" aria-hidden="true" tabindex="-1"></a>  mutant_names<span class="ot">&lt;-</span><span class="fu">rownames</span>(Known_mat)</span>
<span id="cb94-990"><a href="functions.html#cb94-990" aria-hidden="true" tabindex="-1"></a>  num_clones <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Known_mat)</span>
<span id="cb94-991"><a href="functions.html#cb94-991" aria-hidden="true" tabindex="-1"></a>  num_states <span class="ot">&lt;-</span> num_type<span class="sc">^</span>num_mutations</span>
<span id="cb94-992"><a href="functions.html#cb94-992" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-993"><a href="functions.html#cb94-993" aria-hidden="true" tabindex="-1"></a>  possible_mut_list<span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">apply</span>(Known_mat,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">list</span>(<span class="dv">0</span><span class="sc">:</span><span class="fu">max</span>(<span class="fu">unique</span>(x))) }),<span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb94-994"><a href="functions.html#cb94-994" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-995"><a href="functions.html#cb94-995" aria-hidden="true" tabindex="-1"></a>  states<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">expand.grid</span>(possible_mut_list))</span>
<span id="cb94-996"><a href="functions.html#cb94-996" aria-hidden="true" tabindex="-1"></a>  state_interactions<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">expand.grid</span>(<span class="fu">apply</span>(states[,<span class="dv">1</span><span class="sc">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>)}),</span>
<span id="cb94-997"><a href="functions.html#cb94-997" aria-hidden="true" tabindex="-1"></a>                                             <span class="fu">apply</span>(states[,<span class="dv">1</span><span class="sc">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">paste</span>(x,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="at">sep=</span><span class="st">&quot;_&quot;</span>)})))</span>
<span id="cb94-998"><a href="functions.html#cb94-998" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-999"><a href="functions.html#cb94-999" aria-hidden="true" tabindex="-1"></a>  state_interactions<span class="sc">$</span>possible<span class="ot">&lt;-</span><span class="fu">ifelse</span>(<span class="fu">apply</span>(state_interactions,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-1000"><a href="functions.html#cb94-1000" aria-hidden="true" tabindex="-1"></a>    A<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">do.call</span>(cbind,<span class="fu">strsplit</span>(<span class="fu">as.character</span>(x[<span class="dv">1</span>]),<span class="at">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb94-1001"><a href="functions.html#cb94-1001" aria-hidden="true" tabindex="-1"></a>    B<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">do.call</span>(cbind,<span class="fu">strsplit</span>(<span class="fu">as.character</span>(x[<span class="dv">2</span>]),<span class="at">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb94-1002"><a href="functions.html#cb94-1002" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">abs</span>(A<span class="sc">-</span>B))<span class="sc">&lt;=</span><span class="dv">1</span></span>
<span id="cb94-1003"><a href="functions.html#cb94-1003" aria-hidden="true" tabindex="-1"></a>  }),<span class="dv">0</span>,<span class="cn">NA</span>)</span>
<span id="cb94-1004"><a href="functions.html#cb94-1004" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-1005"><a href="functions.html#cb94-1005" aria-hidden="true" tabindex="-1"></a>  state_interactions<span class="sc">$</span>action<span class="ot">&lt;-</span><span class="fu">apply</span>(state_interactions,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-1006"><a href="functions.html#cb94-1006" aria-hidden="true" tabindex="-1"></a>    A<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">do.call</span>(cbind,<span class="fu">strsplit</span>(<span class="fu">as.character</span>(x[<span class="dv">1</span>]),<span class="at">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb94-1007"><a href="functions.html#cb94-1007" aria-hidden="true" tabindex="-1"></a>    B<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">do.call</span>(cbind,<span class="fu">strsplit</span>(<span class="fu">as.character</span>(x[<span class="dv">2</span>]),<span class="at">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb94-1008"><a href="functions.html#cb94-1008" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(x[<span class="st">&quot;possible&quot;</span>])){</span>
<span id="cb94-1009"><a href="functions.html#cb94-1009" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">sum</span>(<span class="fu">abs</span>(B<span class="sc">-</span>A))<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb94-1010"><a href="functions.html#cb94-1010" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">&quot;stay&quot;</span>)</span>
<span id="cb94-1011"><a href="functions.html#cb94-1011" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span>{</span>
<span id="cb94-1012"><a href="functions.html#cb94-1012" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(mutant_names[<span class="fu">which</span>((B<span class="sc">-</span>A)<span class="sc">==</span><span class="dv">1</span>)])</span>
<span id="cb94-1013"><a href="functions.html#cb94-1013" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb94-1014"><a href="functions.html#cb94-1014" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-1015"><a href="functions.html#cb94-1015" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb94-1016"><a href="functions.html#cb94-1016" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-1017"><a href="functions.html#cb94-1017" aria-hidden="true" tabindex="-1"></a>  dat<span class="ot">&lt;-</span><span class="fu">setNames</span>(state_interactions<span class="sc">%&gt;%</span><span class="fu">filter</span>(action<span class="sc">%in%</span><span class="fu">c</span>(mutant_names,<span class="st">&quot;stay&quot;</span>)),</span>
<span id="cb94-1018"><a href="functions.html#cb94-1018" aria-hidden="true" tabindex="-1"></a>                <span class="fu">c</span>(<span class="st">&quot;State&quot;</span>,<span class="st">&quot;NextState&quot;</span>,<span class="st">&quot;Reward&quot;</span>,<span class="st">&quot;Action&quot;</span>))[,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">3</span>)]</span>
<span id="cb94-1019"><a href="functions.html#cb94-1019" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-1020"><a href="functions.html#cb94-1020" aria-hidden="true" tabindex="-1"></a>  dat<span class="sc">$</span>Reward <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">apply</span>(dat,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-1021"><a href="functions.html#cb94-1021" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(x<span class="sc">$</span>NextState<span class="sc">%in%</span><span class="fu">names</span>(weights),weights[x<span class="sc">$</span>NextState],x<span class="sc">$</span>Reward)</span>
<span id="cb94-1022"><a href="functions.html#cb94-1022" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb94-1023"><a href="functions.html#cb94-1023" aria-hidden="true" tabindex="-1"></a>  dat<span class="sc">$</span>Reward <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">apply</span>(dat,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb94-1024"><a href="functions.html#cb94-1024" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(x<span class="sc">$</span>Action<span class="sc">%in%</span><span class="st">&quot;stay&quot;</span>,<span class="dv">0</span>,x<span class="sc">$</span>Reward)</span>
<span id="cb94-1025"><a href="functions.html#cb94-1025" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb94-1026"><a href="functions.html#cb94-1026" aria-hidden="true" tabindex="-1"></a>  dat<span class="sc">$</span>State <span class="ot">&lt;-</span> <span class="fu">as.character</span>(dat<span class="sc">$</span>State)</span>
<span id="cb94-1027"><a href="functions.html#cb94-1027" aria-hidden="true" tabindex="-1"></a>  dat<span class="sc">$</span>NextState <span class="ot">&lt;-</span> <span class="fu">as.character</span>(dat<span class="sc">$</span>NextState)</span>
<span id="cb94-1028"><a href="functions.html#cb94-1028" aria-hidden="true" tabindex="-1"></a>  dat<span class="sc">$</span>Action <span class="ot">&lt;-</span> <span class="fu">as.character</span>(dat<span class="sc">$</span>Action)</span>
<span id="cb94-1029"><a href="functions.html#cb94-1029" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-1030"><a href="functions.html#cb94-1030" aria-hidden="true" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">gamma =</span> <span class="fl">0.9</span>)</span>
<span id="cb94-1031"><a href="functions.html#cb94-1031" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">ReinforcementLearning</span>(<span class="at">data =</span> dat, <span class="at">s =</span> <span class="st">&quot;State&quot;</span>, <span class="at">a =</span> <span class="st">&quot;Action&quot;</span>, <span class="at">r =</span> <span class="st">&quot;Reward&quot;</span>,  <span class="at">s_new =</span> <span class="st">&quot;NextState&quot;</span>,  <span class="at">iter =</span>  <span class="dv">1</span>,<span class="at">control=</span>control)</span>
<span id="cb94-1032"><a href="functions.html#cb94-1032" aria-hidden="true" tabindex="-1"></a>  x<span class="ot">&lt;-</span> model<span class="sc">$</span>Q</span>
<span id="cb94-1033"><a href="functions.html#cb94-1033" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(x) <span class="ot">&lt;-</span> <span class="fu">substring</span>(<span class="fu">rownames</span>(x),<span class="dv">2</span>)</span>
<span id="cb94-1034"><a href="functions.html#cb94-1034" aria-hidden="true" tabindex="-1"></a>  Q_mat <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">melt</span>(x),<span class="fu">c</span>(<span class="st">&quot;State&quot;</span>,<span class="st">&quot;Action&quot;</span>,<span class="st">&quot;Q&quot;</span>))</span>
<span id="cb94-1035"><a href="functions.html#cb94-1035" aria-hidden="true" tabindex="-1"></a>  set<span class="ot">&lt;-</span><span class="fu">inner_join</span>(dat,Q_mat,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;State&quot;</span>,<span class="st">&quot;Action&quot;</span>))</span>
<span id="cb94-1036"><a href="functions.html#cb94-1036" aria-hidden="true" tabindex="-1"></a>  set<span class="sc">$</span>Valid <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb94-1037"><a href="functions.html#cb94-1037" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(set)</span>
<span id="cb94-1038"><a href="functions.html#cb94-1038" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-1039"><a href="functions.html#cb94-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-1040"><a href="functions.html#cb94-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-1041"><a href="functions.html#cb94-1041" aria-hidden="true" tabindex="-1"></a>plot_clonal_heatmap_and_barplot_with_SD <span class="ot">&lt;-</span><span class="cf">function</span>(sample,output_folder,clonal_abundance,clonal_architecture,clone_cell_count,shrink)</span>
<span id="cb94-1042"><a href="functions.html#cb94-1042" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb94-1043"><a href="functions.html#cb94-1043" aria-hidden="true" tabindex="-1"></a>  clonal_abundance_subset <span class="ot">&lt;-</span><span class="fu">data.frame</span>( clonal_abundance[[sample]])<span class="co">#%&gt;%filter(Count&gt;=5)</span></span>
<span id="cb94-1044"><a href="functions.html#cb94-1044" aria-hidden="true" tabindex="-1"></a>  clones_to_use <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">as.character</span>(clonal_abundance_subset<span class="sc">$</span>Clone),<span class="fu">as.character</span>(clonal_architecture[[sample]]<span class="sc">$</span>Clone))</span>
<span id="cb94-1045"><a href="functions.html#cb94-1045" aria-hidden="true" tabindex="-1"></a>  clonal_architecture_subset <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(clonal_architecture[[sample]])<span class="sc">%&gt;%</span></span>
<span id="cb94-1046"><a href="functions.html#cb94-1046" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">data.frame</span>(clonal_architecture[[sample]])<span class="sc">$</span>Clone<span class="sc">%in%</span>clones_to_use)</span>
<span id="cb94-1047"><a href="functions.html#cb94-1047" aria-hidden="true" tabindex="-1"></a>  clonal_abundance_subset <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(clonal_abundance_subset)<span class="sc">%&gt;%</span></span>
<span id="cb94-1048"><a href="functions.html#cb94-1048" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Clone<span class="sc">%in%</span>clones_to_use)</span>
<span id="cb94-1049"><a href="functions.html#cb94-1049" aria-hidden="true" tabindex="-1"></a>  genes_to_display <span class="ot">&lt;-</span><span class="fu">unique</span>(<span class="fu">as.character</span>(clonal_architecture_subset[clonal_architecture_subset<span class="sc">$</span>Genotype<span class="sc">%in%</span><span class="fu">c</span>(<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>),<span class="st">&quot;Mutant&quot;</span>]))</span>
<span id="cb94-1050"><a href="functions.html#cb94-1050" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-1051"><a href="functions.html#cb94-1051" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(shrink<span class="sc">==</span><span class="cn">TRUE</span>){</span>
<span id="cb94-1052"><a href="functions.html#cb94-1052" aria-hidden="true" tabindex="-1"></a>    clonal_architecture_subset <span class="ot">&lt;-</span>clonal_architecture_subset<span class="sc">%&gt;%</span><span class="fu">filter</span>(Mutant<span class="sc">%in%</span>genes_to_display)</span>
<span id="cb94-1053"><a href="functions.html#cb94-1053" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-1054"><a href="functions.html#cb94-1054" aria-hidden="true" tabindex="-1"></a>  clonal_architecture_subset<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_architecture_subset<span class="sc">$</span>Clone, <span class="at">levels=</span><span class="fu">rev</span>(clonal_abundance_subset<span class="sc">$</span>Clone))</span>
<span id="cb94-1055"><a href="functions.html#cb94-1055" aria-hidden="true" tabindex="-1"></a>  clonal_abundance_subset<span class="sc">$</span>Clone <span class="ot">&lt;-</span> <span class="fu">factor</span>(clonal_abundance_subset<span class="sc">$</span>Clone, <span class="at">levels=</span><span class="fu">levels</span>(clonal_architecture_subset<span class="sc">$</span>Clone))</span>
<span id="cb94-1056"><a href="functions.html#cb94-1056" aria-hidden="true" tabindex="-1"></a>  gg_heatmap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> clonal_architecture_subset, <span class="fu">aes</span>(<span class="at">x =</span> Clone, <span class="at">y =</span> <span class="fu">factor</span>(Mutant,<span class="at">levels=</span><span class="fu">rev</span>(<span class="fu">levels</span>(<span class="fu">factor</span>(Mutant)))), <span class="at">fill =</span> Genotype)) <span class="sc">+</span> </span>
<span id="cb94-1057"><a href="functions.html#cb94-1057" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span><span class="co"># scale_y_discrete(limits = rev(levels(Mutant)))+</span></span>
<span id="cb94-1058"><a href="functions.html#cb94-1058" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-1059"><a href="functions.html#cb94-1059" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;WT&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb94-1060"><a href="functions.html#cb94-1060" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Heterozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb94-1061"><a href="functions.html#cb94-1061" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Homozygous&quot;</span><span class="ot">=</span><span class="fu">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb94-1062"><a href="functions.html#cb94-1062" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Unknown&quot;</span><span class="ot">=</span><span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="sc">+</span></span>
<span id="cb94-1063"><a href="functions.html#cb94-1063" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb94-1064"><a href="functions.html#cb94-1064" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-1065"><a href="functions.html#cb94-1065" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="at">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb94-1066"><a href="functions.html#cb94-1066" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb94-1067"><a href="functions.html#cb94-1067" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-1068"><a href="functions.html#cb94-1068" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-1069"><a href="functions.html#cb94-1069" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb94-1070"><a href="functions.html#cb94-1070" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-1071"><a href="functions.html#cb94-1071" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-1072"><a href="functions.html#cb94-1072" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb94-1073"><a href="functions.html#cb94-1073" aria-hidden="true" tabindex="-1"></a>  gg_clonal_barplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(clonal_abundance_subset), <span class="fu">aes</span>(<span class="at">x =</span> Clone, <span class="at">y =</span> Count)) <span class="sc">+</span> </span>
<span id="cb94-1074"><a href="functions.html#cb94-1074" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="fu">aes</span>(<span class="at">fill =</span> Count)) <span class="sc">+</span> <span class="fu">theme_gray</span>() <span class="sc">+</span></span>
<span id="cb94-1075"><a href="functions.html#cb94-1075" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">6</span>)<span class="sc">+</span></span>
<span id="cb94-1076"><a href="functions.html#cb94-1076" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fu">max</span>(clonal_abundance_subset<span class="sc">$</span>Count)<span class="sc">*</span><span class="fl">1.3</span>) <span class="sc">+</span> </span>
<span id="cb94-1077"><a href="functions.html#cb94-1077" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="sc">+</span></span>
<span id="cb94-1078"><a href="functions.html#cb94-1078" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>), <span class="at">width =</span> <span class="fl">0.2</span>)<span class="sc">+</span></span>
<span id="cb94-1079"><a href="functions.html#cb94-1079" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>Count), <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.9</span>), <span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.25</span>,<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb94-1080"><a href="functions.html#cb94-1080" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_distiller</span>(<span class="at">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;Reds&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb94-1081"><a href="functions.html#cb94-1081" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),  <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line=</span><span class="fu">element_blank</span>(),</span>
<span id="cb94-1082"><a href="functions.html#cb94-1082" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb94-1083"><a href="functions.html#cb94-1083" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin=</span><span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="sc">-</span><span class="fl">0.2</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb94-1084"><a href="functions.html#cb94-1084" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-1085"><a href="functions.html#cb94-1085" aria-hidden="true" tabindex="-1"></a>  grob.title <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(<span class="fu">paste</span>(sample,<span class="st">&quot;-&quot;</span>), <span class="at">hjust=</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">12</span>))</span>
<span id="cb94-1086"><a href="functions.html#cb94-1086" aria-hidden="true" tabindex="-1"></a>  final_plot<span class="ot">&lt;-</span><span class="fu">plot_grid</span>(grob.title,gg_clonal_barplot,gg_heatmap,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">align=</span><span class="st">&quot;hv&quot;</span>,<span class="at">axis=</span><span class="st">&quot;l&quot;</span>,<span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="fl">0.75</span>))</span>
<span id="cb94-1087"><a href="functions.html#cb94-1087" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-1088"><a href="functions.html#cb94-1088" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save_plot</span>(<span class="fu">paste</span>(output_folder,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>),final_plot, <span class="at">ncol=</span><span class="dv">1</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb94-1089"><a href="functions.html#cb94-1089" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-1090"><a href="functions.html#cb94-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-1091"><a href="functions.html#cb94-1091" aria-hidden="true" tabindex="-1"></a>query_initiating_mutations<span class="ot">&lt;-</span><span class="cf">function</span>(graph_results){</span>
<span id="cb94-1092"><a href="functions.html#cb94-1092" aria-hidden="true" tabindex="-1"></a>  start_index<span class="ot">&lt;-</span><span class="fu">paste</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">length</span>(<span class="fu">strsplit</span>(graph_results<span class="sc">$</span>State[<span class="dv">1</span>],<span class="at">split=</span><span class="st">&quot;_&quot;</span>)[[<span class="dv">1</span>]])),<span class="at">sep=</span><span class="st">&quot;_&quot;</span>,<span class="at">collapse=</span><span class="st">&quot;_&quot;</span>)</span>
<span id="cb94-1093"><a href="functions.html#cb94-1093" aria-hidden="true" tabindex="-1"></a>  possible_starting_actions<span class="ot">&lt;-</span>graph_results<span class="sc">%&gt;%</span><span class="fu">filter</span>(State<span class="sc">==</span>start_index<span class="sc">&amp;</span>Action<span class="sc">!=</span><span class="st">&quot;stay&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">pull</span>(Action)</span>
<span id="cb94-1094"><a href="functions.html#cb94-1094" aria-hidden="true" tabindex="-1"></a>  final_results<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb94-1095"><a href="functions.html#cb94-1095" aria-hidden="true" tabindex="-1"></a>  initating_action_count<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-1096"><a href="functions.html#cb94-1096" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(initating_action <span class="cf">in</span> possible_starting_actions){</span>
<span id="cb94-1097"><a href="functions.html#cb94-1097" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(initating_action)</span>
<span id="cb94-1098"><a href="functions.html#cb94-1098" aria-hidden="true" tabindex="-1"></a>    set <span class="ot">&lt;-</span> graph_results</span>
<span id="cb94-1099"><a href="functions.html#cb94-1099" aria-hidden="true" tabindex="-1"></a>    initating_action_count<span class="ot">&lt;-</span>initating_action_count<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb94-1100"><a href="functions.html#cb94-1100" aria-hidden="true" tabindex="-1"></a>    storage_results<span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb94-1101"><a href="functions.html#cb94-1101" aria-hidden="true" tabindex="-1"></a>    branches<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-1102"><a href="functions.html#cb94-1102" aria-hidden="true" tabindex="-1"></a>    state_to_kill <span class="ot">&lt;-</span> set<span class="sc">%&gt;%</span><span class="fu">filter</span>(State<span class="sc">==</span>start_index<span class="sc">&amp;</span>Action<span class="sc">==</span>initating_action)<span class="sc">%&gt;%</span><span class="fu">pull</span>(NextState)</span>
<span id="cb94-1103"><a href="functions.html#cb94-1103" aria-hidden="true" tabindex="-1"></a>    start_killed <span class="ot">&lt;-</span> <span class="fu">sum</span>(set<span class="sc">%&gt;%</span><span class="fu">filter</span>(State<span class="sc">==</span>state_to_kill)<span class="sc">%&gt;%</span><span class="fu">pull</span>(Valid))</span>
<span id="cb94-1104"><a href="functions.html#cb94-1104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(start_killed<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb94-1105"><a href="functions.html#cb94-1105" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(branches)</span></span>
<span id="cb94-1106"><a href="functions.html#cb94-1106" aria-hidden="true" tabindex="-1"></a>     <span class="co"># print(start_killed)</span></span>
<span id="cb94-1107"><a href="functions.html#cb94-1107" aria-hidden="true" tabindex="-1"></a>      branches <span class="ot">&lt;-</span> branches <span class="sc">+</span><span class="dv">1</span></span>
<span id="cb94-1108"><a href="functions.html#cb94-1108" aria-hidden="true" tabindex="-1"></a>      number_of_mutations<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-1109"><a href="functions.html#cb94-1109" aria-hidden="true" tabindex="-1"></a>      state_log<span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb94-1110"><a href="functions.html#cb94-1110" aria-hidden="true" tabindex="-1"></a>      optimal_reward<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb94-1111"><a href="functions.html#cb94-1111" aria-hidden="true" tabindex="-1"></a>      action_log<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb94-1112"><a href="functions.html#cb94-1112" aria-hidden="true" tabindex="-1"></a>      current_state<span class="ot">&lt;-</span> start_index</span>
<span id="cb94-1113"><a href="functions.html#cb94-1113" aria-hidden="true" tabindex="-1"></a>      indicator<span class="ot">&lt;-</span><span class="cn">TRUE</span></span>
<span id="cb94-1114"><a href="functions.html#cb94-1114" aria-hidden="true" tabindex="-1"></a>      nextState<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb94-1115"><a href="functions.html#cb94-1115" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span>(current_state<span class="sc">!=</span>nextState)  {</span>
<span id="cb94-1116"><a href="functions.html#cb94-1116" aria-hidden="true" tabindex="-1"></a>       <span class="co"># print(number_of_mutations)</span></span>
<span id="cb94-1117"><a href="functions.html#cb94-1117" aria-hidden="true" tabindex="-1"></a>        number_of_mutations <span class="ot">&lt;-</span> number_of_mutations<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb94-1118"><a href="functions.html#cb94-1118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(number_of_mutations<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb94-1119"><a href="functions.html#cb94-1119" aria-hidden="true" tabindex="-1"></a>          state_log[[number_of_mutations]] <span class="ot">&lt;-</span> start_index</span>
<span id="cb94-1120"><a href="functions.html#cb94-1120" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb94-1121"><a href="functions.html#cb94-1121" aria-hidden="true" tabindex="-1"></a>        current_state  <span class="ot">&lt;-</span> state_log[[number_of_mutations]]</span>
<span id="cb94-1122"><a href="functions.html#cb94-1122" aria-hidden="true" tabindex="-1"></a>        nextState_indicator<span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb94-1123"><a href="functions.html#cb94-1123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb94-1124"><a href="functions.html#cb94-1124" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span>(nextState_indicator<span class="sc">==</span><span class="cn">FALSE</span>){</span>
<span id="cb94-1125"><a href="functions.html#cb94-1125" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb94-1126"><a href="functions.html#cb94-1126" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(number_of_mutations<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb94-1127"><a href="functions.html#cb94-1127" aria-hidden="true" tabindex="-1"></a>            max_potential_action_index<span class="ot">&lt;-</span>  set<span class="sc">%&gt;%</span></span>
<span id="cb94-1128"><a href="functions.html#cb94-1128" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(State<span class="sc">==</span>current_state<span class="sc">&amp;</span>Action<span class="sc">==</span>initating_action)</span>
<span id="cb94-1129"><a href="functions.html#cb94-1129" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb94-1130"><a href="functions.html#cb94-1130" aria-hidden="true" tabindex="-1"></a>            max_potential_action_index <span class="ot">&lt;-</span> set<span class="sc">%&gt;%</span></span>
<span id="cb94-1131"><a href="functions.html#cb94-1131" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(State<span class="sc">==</span>current_state<span class="sc">&amp;</span>Valid<span class="sc">==</span><span class="cn">TRUE</span>)<span class="sc">%&gt;%</span></span>
<span id="cb94-1132"><a href="functions.html#cb94-1132" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(Q<span class="sc">==</span><span class="fu">max</span>(Q))<span class="sc">%&gt;%</span><span class="fu">sample_n</span>(<span class="dv">1</span>)</span>
<span id="cb94-1133"><a href="functions.html#cb94-1133" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb94-1134"><a href="functions.html#cb94-1134" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">nrow</span>(max_potential_action_index)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb94-1135"><a href="functions.html#cb94-1135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb94-1136"><a href="functions.html#cb94-1136" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb94-1137"><a href="functions.html#cb94-1137" aria-hidden="true" tabindex="-1"></a>          max_potential_action <span class="ot">&lt;-</span> max_potential_action_index<span class="sc">%&gt;%</span><span class="fu">pull</span>(NextState)</span>
<span id="cb94-1138"><a href="functions.html#cb94-1138" aria-hidden="true" tabindex="-1"></a>          next_valid_action <span class="ot">&lt;-</span> <span class="fu">any</span>(set<span class="sc">%&gt;%</span><span class="fu">filter</span>(State<span class="sc">==</span>max_potential_action<span class="sc">&amp;</span>Action<span class="sc">!=</span><span class="st">&quot;stay&quot;</span>)<span class="sc">%&gt;%</span><span class="fu">pull</span>(Valid))  </span>
<span id="cb94-1139"><a href="functions.html#cb94-1139" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(next_valid_action<span class="sc">==</span><span class="cn">TRUE</span>){</span>
<span id="cb94-1140"><a href="functions.html#cb94-1140" aria-hidden="true" tabindex="-1"></a>            nextState <span class="ot">&lt;-</span>max_potential_action</span>
<span id="cb94-1141"><a href="functions.html#cb94-1141" aria-hidden="true" tabindex="-1"></a>            current_action <span class="ot">&lt;-</span>  max_potential_action_index<span class="sc">%&gt;%</span><span class="fu">pull</span>(Action)</span>
<span id="cb94-1142"><a href="functions.html#cb94-1142" aria-hidden="true" tabindex="-1"></a>            nextState_indicator<span class="sc">==</span><span class="cn">TRUE</span></span>
<span id="cb94-1143"><a href="functions.html#cb94-1143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb94-1144"><a href="functions.html#cb94-1144" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span>{</span>
<span id="cb94-1145"><a href="functions.html#cb94-1145" aria-hidden="true" tabindex="-1"></a>            set[set<span class="sc">$</span>State<span class="sc">%in%</span>max_potential_action_index[<span class="st">&quot;State&quot;</span>]<span class="sc">&amp;</span></span>
<span id="cb94-1146"><a href="functions.html#cb94-1146" aria-hidden="true" tabindex="-1"></a>                  set<span class="sc">$</span>Action<span class="sc">%in%</span>max_potential_action_index[<span class="st">&quot;Action&quot;</span>],<span class="st">&quot;Valid&quot;</span>] <span class="ot">&lt;-</span> <span class="cn">FALSE</span>  </span>
<span id="cb94-1147"><a href="functions.html#cb94-1147" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb94-1148"><a href="functions.html#cb94-1148" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb94-1149"><a href="functions.html#cb94-1149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">nrow</span>(set<span class="sc">%&gt;%</span><span class="fu">filter</span>(State<span class="sc">==</span>current_state<span class="sc">&amp;</span>Action<span class="sc">==</span>current_action))<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb94-1150"><a href="functions.html#cb94-1150" aria-hidden="true" tabindex="-1"></a>          optimal_reward[[number_of_mutations]] <span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb94-1151"><a href="functions.html#cb94-1151" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb94-1152"><a href="functions.html#cb94-1152" aria-hidden="true" tabindex="-1"></a>          optimal_reward[[number_of_mutations]] <span class="ot">&lt;-</span> set<span class="sc">%&gt;%</span></span>
<span id="cb94-1153"><a href="functions.html#cb94-1153" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(State<span class="sc">==</span>current_state<span class="sc">&amp;</span>Action<span class="sc">==</span>current_action)<span class="sc">%&gt;%</span></span>
<span id="cb94-1154"><a href="functions.html#cb94-1154" aria-hidden="true" tabindex="-1"></a>            <span class="fu">pull</span>(Reward) </span>
<span id="cb94-1155"><a href="functions.html#cb94-1155" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb94-1156"><a href="functions.html#cb94-1156" aria-hidden="true" tabindex="-1"></a>        state_log[[number_of_mutations<span class="sc">+</span><span class="dv">1</span>]]<span class="ot">&lt;-</span> nextState</span>
<span id="cb94-1157"><a href="functions.html#cb94-1157" aria-hidden="true" tabindex="-1"></a>        action_log[[number_of_mutations]] <span class="ot">&lt;-</span> current_action </span>
<span id="cb94-1158"><a href="functions.html#cb94-1158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(current_action<span class="sc">==</span>nextState){</span>
<span id="cb94-1159"><a href="functions.html#cb94-1159" aria-hidden="true" tabindex="-1"></a>          indicator<span class="sc">==</span><span class="cn">FALSE</span></span>
<span id="cb94-1160"><a href="functions.html#cb94-1160" aria-hidden="true" tabindex="-1"></a>          state_log[[number_of_mutations<span class="sc">+</span><span class="dv">1</span>]]<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb94-1161"><a href="functions.html#cb94-1161" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span></span>
<span id="cb94-1162"><a href="functions.html#cb94-1162" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb94-1163"><a href="functions.html#cb94-1163" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb94-1164"><a href="functions.html#cb94-1164" aria-hidden="true" tabindex="-1"></a>      optimal_reward[[number_of_mutations<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb94-1165"><a href="functions.html#cb94-1165" aria-hidden="true" tabindex="-1"></a>      action_log[[number_of_mutations<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb94-1166"><a href="functions.html#cb94-1166" aria-hidden="true" tabindex="-1"></a>      storage_results[[branches]] <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="st">&quot;states&quot;</span><span class="ot">=</span><span class="fu">do.call</span>(rbind,state_log),<span class="co">#[1:(length(state_log)-1)]),</span></span>
<span id="cb94-1167"><a href="functions.html#cb94-1167" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">&quot;actions&quot;</span><span class="ot">=</span><span class="fu">do.call</span>(rbind,action_log),</span>
<span id="cb94-1168"><a href="functions.html#cb94-1168" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">&quot;reward&quot;</span><span class="ot">=</span><span class="fu">do.call</span>(rbind,optimal_reward),</span>
<span id="cb94-1169"><a href="functions.html#cb94-1169" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">&quot;nextState&quot;</span><span class="ot">=</span><span class="fu">do.call</span>(rbind,<span class="fu">c</span>(state_log[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(state_log)],<span class="cn">NA</span>)) )</span>
<span id="cb94-1170"><a href="functions.html#cb94-1170" aria-hidden="true" tabindex="-1"></a>      storage_results[[branches]] <span class="ot">&lt;-</span> storage_results[[branches]]<span class="sc">%&gt;%</span></span>
<span id="cb94-1171"><a href="functions.html#cb94-1171" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(states<span class="sc">!=</span>nextState)</span>
<span id="cb94-1172"><a href="functions.html#cb94-1172" aria-hidden="true" tabindex="-1"></a>      storage_results[[branches]]<span class="sc">$</span>cumulative_reward <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(storage_results[[branches]]<span class="sc">$</span>reward)</span>
<span id="cb94-1173"><a href="functions.html#cb94-1173" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb94-1174"><a href="functions.html#cb94-1174" aria-hidden="true" tabindex="-1"></a>      <span class="co">#storage_results[[branches]] &lt;-storage_results[[branches]][1:which.max(storage_results[[branches]]$cumulative_reward), ]</span></span>
<span id="cb94-1175"><a href="functions.html#cb94-1175" aria-hidden="true" tabindex="-1"></a>      set[set<span class="sc">$</span>State<span class="sc">%in%</span>current_state<span class="sc">&amp;</span>set<span class="sc">$</span>Action<span class="sc">%in%</span>current_action,<span class="st">&quot;Valid&quot;</span>] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb94-1176"><a href="functions.html#cb94-1176" aria-hidden="true" tabindex="-1"></a>      start_killed <span class="ot">&lt;-</span> <span class="fu">sum</span>(set<span class="sc">%&gt;%</span><span class="fu">filter</span>(State<span class="sc">==</span>state_to_kill)<span class="sc">%&gt;%</span><span class="fu">pull</span>(Valid))</span>
<span id="cb94-1177"><a href="functions.html#cb94-1177" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-1178"><a href="functions.html#cb94-1178" aria-hidden="true" tabindex="-1"></a>    final_results[[initating_action_count]]<span class="ot">&lt;-</span>storage_results[<span class="sc">!</span><span class="fu">duplicated</span>(storage_results)]</span>
<span id="cb94-1179"><a href="functions.html#cb94-1179" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-1180"><a href="functions.html#cb94-1180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(final_results)<span class="ot">&lt;-</span>possible_starting_actions</span>
<span id="cb94-1181"><a href="functions.html#cb94-1181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final_results)</span>
<span id="cb94-1182"><a href="functions.html#cb94-1182" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
<!-- </div> -->
            </section>

          </div>
        </div>
      </div>
<a href="AppendixA.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["scDNA.pdf", "scDNA.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
